<script>
// ============================================
// ROUTINE APP - Frontend JavaScript
// ============================================

(function() {
  'use strict';

  // ============================================
  // DIAGNOSTICS
  // ============================================

  const diagnostics = {
    lastCall: null,
    lastResponse: null,
    lastError: null,
    history: []
  };

  function recordDiagnostic(type, data) {
    const entry = { type, data, timestamp: new Date().toISOString() };
    if (type === 'call') diagnostics.lastCall = entry;
    if (type === 'response') diagnostics.lastResponse = entry;
    if (type === 'error') diagnostics.lastError = entry;
    diagnostics.history.unshift(entry);
    if (diagnostics.history.length > 50) diagnostics.history = diagnostics.history.slice(0, 50);
  }

  window.diagnostics = diagnostics;

  // ============================================
  // STATE MANAGEMENT
  // ============================================
  
  const appState = {
    userKey: null,
    habits: [],
    habitLogs: [],
    tasks: [],
    taskChecklists: [],
    goals: [],
    goalLogs: [],
    journals: [],
    currentView: 'dashboard',
    isLoading: false,
    isOffline: false,
    preferences: {
      theme: 'dark',
      weekStart: 'monday',
      timeFormat: '24h',
      reduceAnimations: false
    }
  };

  // ============================================
  // UTILITIES
  // ============================================

  const utils = {
    sanitize: function(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    },
    
    formatDate: function(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('pt-BR');
    },
    
    getTodayISO: function() {
      return new Date().toISOString().split('T')[0];
    },
    
    daysBetween: function(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      const diff = Math.abs(d2 - d1);
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    },
    
    calculateStreak: function(logs, habitId) {
      const sortedLogs = logs
        .filter(l => l.habitId === habitId && l.completed)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (sortedLogs.length === 0) return { current: 0, max: 0 };
      
      let currentStreak = 0;
      let maxStreak = 0;
      let tempStreak = 0;
      let expectedDate = new Date(this.getTodayISO());
      
      for (let i = 0; i < sortedLogs.length; i++) {
        const logDate = new Date(sortedLogs[i].date);
        
        if (i === 0) {
          const daysDiff = this.daysBetween(logDate, expectedDate);
          if (daysDiff <= 1) {
            currentStreak = 1;
            tempStreak = 1;
          }
        }
        
        if (i > 0) {
          const prevDate = new Date(sortedLogs[i-1].date);
          const daysDiff = this.daysBetween(logDate, prevDate);
          
          if (daysDiff === 1) {
            tempStreak++;
            if (i === 0 || currentStreak > 0) {
              currentStreak = tempStreak;
            }
          } else {
            tempStreak = 1;
            currentStreak = 0;
          }
        }
        
        maxStreak = Math.max(maxStreak, tempStreak);
      }
      
      return { current: currentStreak, max: maxStreak };
    },
    
    debounce: function(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },
    
    generateTempId: function() {
      return 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
  };

  // ============================================
  // LOCAL STORAGE
  // ============================================

  const storage = {
    save: function(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e) {
        console.error('Error saving to localStorage:', e);
      }
    },
    
    load: function(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('Error loading from localStorage:', e);
        return null;
      }
    },
    
    remove: function(key) {
      try {
        localStorage.removeItem(key);
      } catch (e) {
        console.error('Error removing from localStorage:', e);
      }
    }
  };

  // ============================================
  // TOAST NOTIFICATIONS
  // ============================================

  const toast = {
    show: function(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      
      const icons = {
        success: 'check_circle',
        error: 'error',
        info: 'info'
      };
      
      toastEl.innerHTML = `
        <span class="material-icons toast-icon">${icons[type] || 'info'}</span>
        <div class="toast-content">
          <div class="toast-message">${utils.sanitize(message)}</div>
        </div>
      `;
      
      container.appendChild(toastEl);
      
      setTimeout(() => {
        toastEl.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toastEl.remove(), 300);
      }, duration);
    },
    
    success: function(message) {
      this.show(message, 'success');
    },
    
    error: function(message) {
      this.show(message, 'error', 4000);
    },
    
    info: function(message) {
      this.show(message, 'info');
    }
  };

  // ============================================
  // MODAL
  // ============================================

  const modal = {
    open: function(title, content, actions = []) {
      const container = document.getElementById('modal-container');
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const actionsHTML = actions.map(action => {
        const btnClass = action.primary ? 'btn-primary' : 'btn-secondary';
        return `<button class="btn ${btnClass}" onclick="${action.onclick}">${action.label}</button>`;
      }).join('');
      
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">${utils.sanitize(title)}</h2>
            <button class="modal-close" onclick="modal.close()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          ${actions.length > 0 ? `
            <div class="modal-footer">
              ${actionsHTML}
            </div>
          ` : ''}
        </div>
      `;
      
      container.innerHTML = '';
      container.appendChild(overlay);
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          this.close();
        }
      });
    },
    
    close: function() {
      const container = document.getElementById('modal-container');
      container.innerHTML = '';
    }
  };

  window.modal = modal;

  // ============================================
  // API CALLS
  // ============================================

  const api = {
    call: function(functionName, ...args) {
      return new Promise((resolve) => {
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.error('google.script.run n√£o est√° dispon√≠vel');
            resolve({ ok: false, error: 'Ambiente de execu√ß√£o n√£o dispon√≠vel' });
            return;
          }
          
          google.script.run
            .withSuccessHandler((result) => {
              if (result === null || result === undefined) {
                resolve({ ok: false, error: 'Resposta vazia do servidor' });
              } else {
                resolve(result);
              }
            })
            .withFailureHandler((error) => {
              console.error('Erro na chamada API:', error);
              resolve({ ok: false, error: error.message || error.toString() });
            })
            [functionName](...args);
        } catch (error) {
          console.error('Erro ao chamar API:', error);
          resolve({ ok: false, error: error.message || 'Erro desconhecido' });
        }
      });
    },
    
    initApp: async function(userKey) {
      return await this.call('initApp', userKey);
    },
    
    createHabit: async function(habitData) {
      return await this.call('createHabit', appState.userKey, habitData);
    },
    
    updateHabit: async function(habitId, updates) {
      return await this.call('updateHabit', appState.userKey, habitId, updates);
    },
    
    deleteHabit: async function(habitId) {
      return await this.call('deleteHabit', appState.userKey, habitId);
    },
    
    toggleHabitCompletion: async function(habitId, date) {
      return await this.call('toggleHabitCompletion', appState.userKey, habitId, date);
    },
    
    createTask: async function(taskData) {
      return await this.call('createTask', appState.userKey, taskData);
    },
    
    updateTask: async function(taskId, updates) {
      return await this.call('updateTask', appState.userKey, taskId, updates);
    },
    
    deleteTask: async function(taskId) {
      return await this.call('deleteTask', appState.userKey, taskId);
    },
    
    setTaskStatus: async function(taskId, status) {
      return await this.call('setTaskStatus', appState.userKey, taskId, status);
    },
    
    addChecklistItem: async function(taskId, text) {
      return await this.call('addChecklistItem', appState.userKey, taskId, text);
    },
    
    toggleChecklistItem: async function(itemId) {
      return await this.call('toggleChecklistItem', appState.userKey, itemId);
    },
    
    deleteChecklistItem: async function(itemId) {
      return await this.call('deleteChecklistItem', appState.userKey, itemId);
    },
    
    createGoal: async function(goalData) {
      return await this.call('createGoal', appState.userKey, goalData);
    },
    
    updateGoal: async function(goalId, updates) {
      return await this.call('updateGoal', appState.userKey, goalId, updates);
    },
    
    deleteGoal: async function(goalId) {
      return await this.call('deleteGoal', appState.userKey, goalId);
    },
    
    addGoalProgress: async function(goalId, delta, note, date) {
      return await this.call('addGoalProgress', appState.userKey, goalId, delta, note, date);
    },

    exportUserData: async function(format) {
      return await this.call('exportUserData', appState.userKey, format);
    }
  };

  // ============================================
  // THEME MANAGEMENT
  // ============================================

  const theme = {
    init: function() {
      const savedTheme = storage.load('theme') || 'dark';
      this.apply(savedTheme);
      
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          this.apply(newTheme);
          appState.preferences.theme = newTheme;
          storage.save('theme', newTheme);
          storage.save('preferences', appState.preferences);
        });
      }
    },
    
    apply: function(themeName) {
      document.documentElement.setAttribute('data-theme', themeName);
      appState.preferences.theme = themeName;
    }
  };

  // ============================================
  // ROUTER
  // ============================================

  const router = {
    init: function() {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const view = item.getAttribute('data-view');
          this.navigate(view);
        });
      });
      
      window.addEventListener('hashchange', () => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        this.navigate(hash);
      });
      
      const initialView = window.location.hash.slice(1) || 'dashboard';
      this.navigate(initialView);
    },
    
    navigate: function(view) {
      appState.currentView = view;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-view') === view) {
          item.classList.add('active');
        }
      });
      
      this.render(view);
      window.location.hash = view;
    },
    
    render: function(view) {
      const container = document.getElementById('view-container');
      
      switch(view) {
        case 'dashboard':
          views.renderDashboard(container);
          break;
        case 'habits':
          views.renderHabits(container);
          break;
        case 'tasks':
          views.renderTasks(container);
          break;
        case 'kanban':
          views.renderKanban(container);
          break;
        case 'calendar':
          views.renderCalendar(container);
          break;
        case 'goals':
          views.renderGoals(container);
          break;
        case 'settings':
          views.renderSettings(container);
          break;
        default:
          views.renderDashboard(container);
      }
    }
  };

  // ============================================
  // VIEWS - Full Implementation
  // ============================================

  const views = {
    renderDashboard: function(container) {
      const today = utils.getTodayISO();
      const completedHabitsToday = appState.habitLogs.filter(log =>
        log.date === today && log.completed
      ).length;
      const totalHabits = appState.habits.filter(h => h.active !== false).length;
      const activeTasks = appState.tasks.filter(t => t.status !== 'done').length;
      const activeGoals = appState.goals.filter(g => g.status === 'active').length;

      container.innerHTML = `
        <div>
          <h1>Dashboard</h1>

          <div class="kpi-grid">
            <div class="kpi-card glow-blue">
              <div class="kpi-label">Rotinas Hoje</div>
              <div class="kpi-value">${completedHabitsToday}/${totalHabits}</div>
              <div class="kpi-change">${Math.round((completedHabitsToday/totalHabits)*100) || 0}% conclu√≠do</div>
            </div>

            <div class="kpi-card glow-orange">
              <div class="kpi-label">Tarefas Ativas</div>
              <div class="kpi-value">${activeTasks}</div>
              <div class="kpi-change">Pendentes</div>
            </div>

            <div class="kpi-card glow-green">
              <div class="kpi-label">Metas Ativas</div>
              <div class="kpi-value">${activeGoals}</div>
              <div class="kpi-change">Em progresso</div>
            </div>

            <div class="kpi-card glow-purple">
              <div class="kpi-label">Produtividade</div>
              <div class="kpi-value">${Math.round(((completedHabitsToday/totalHabits)*100 || 0))}%</div>
              <div class="kpi-change">Score geral</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Rotinas de Hoje</h2>
              <a href="#habits" class="btn btn-sm btn-primary">Ver todas</a>
            </div>
            <div id="dashboard-habits-list"></div>
          </div>

          <div class="card mt-md">
            <div class="card-header">
              <h2 class="card-title">Tarefas Recentes</h2>
              <a href="#tasks" class="btn btn-sm btn-primary">Ver todas</a>
            </div>
            <div id="dashboard-tasks-list"></div>
          </div>
        </div>
      `;

      this.renderDashboardHabits();
      this.renderDashboardTasks();
    },

    renderDashboardHabits: function() {
      const container = document.getElementById('dashboard-habits-list');
      const activeHabits = appState.habits.filter(h => h.active !== false).slice(0, 5);

      if (activeHabits.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Nenhuma rotina cadastrada</p></div>';
        return;
      }

      const today = utils.getTodayISO();
      container.innerHTML = activeHabits.map(habit => {
        const log = appState.habitLogs.find(l => l.habitId === habit.id && l.date === today);
        const completed = log?.completed || false;

        return `
          <div class="flex-between" style="padding: 12px; border-bottom: 1px solid var(--border-color);">
            <div>
              <strong>${utils.sanitize(habit.name)}</strong>
              <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">${utils.sanitize(habit.description || '')}</p>
            </div>
            <button class="btn btn-sm ${completed ? 'btn-success' : 'btn-secondary'}"
                    onclick="habitHandlers.toggleToday('${habit.id}')">
              <span class="material-icons">${completed ? 'check_circle' : 'radio_button_unchecked'}</span>
            </button>
          </div>
        `;
      }).join('');
    },

    renderDashboardTasks: function() {
      const container = document.getElementById('dashboard-tasks-list');
      const activeTasks = appState.tasks.filter(t => t.status !== 'done').slice(0, 5);

      if (activeTasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Nenhuma tarefa ativa</p></div>';
        return;
      }

      container.innerHTML = activeTasks.map(task => `
        <div class="flex-between" style="padding: 12px; border-bottom: 1px solid var(--border-color);">
          <div>
            <strong>${utils.sanitize(task.title)}</strong>
            <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">
              ${task.status === 'todo' ? 'üìã A fazer' : task.status === 'doing' ? '‚ö° Em andamento' : '‚úÖ Conclu√≠do'}
            </p>
          </div>
          <a href="#tasks" class="btn btn-sm btn-secondary">Ver</a>
        </div>
      `).join('');
    },

    renderHabits: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <h1>Rotinas</h1>
            <button class="btn btn-primary" onclick="habitHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Rotina
            </button>
          </div>

          <div id="habits-list"></div>
        </div>
      `;

      this.renderHabitsList();
    },

    renderHabitsList: function() {
      const container = document.getElementById('habits-list');
      const habits = appState.habits.filter(h => h.active !== false);

      if (habits.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">check_circle</span>
            <h3 class="empty-state-title">Nenhuma rotina cadastrada</h3>
            <p class="empty-state-description">Crie sua primeira rotina para come√ßar!</p>
          </div>
        `;
        return;
      }

      const today = utils.getTodayISO();
      container.innerHTML = `<div class="grid">${habits.map(habit => {
        const log = appState.habitLogs.find(l => l.habitId === habit.id && l.date === today);
        const completed = log?.completed || false;
        const streak = utils.calculateStreak(appState.habitLogs, habit.id);

        return `
          <div class="card ${completed ? 'glow-green' : ''}">
            <div class="flex-between mb-md">
              <h3>${utils.sanitize(habit.name)}</h3>
              <button class="btn btn-sm ${completed ? 'btn-success' : 'btn-secondary'}"
                      onclick="habitHandlers.toggleToday('${habit.id}')">
                <span class="material-icons">${completed ? 'check_circle' : 'radio_button_unchecked'}</span>
              </button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">${utils.sanitize(habit.description || '')}</p>
            <div class="flex gap-md">
              <div style="flex: 1;">
                <small style="color: var(--text-tertiary);">Sequ√™ncia Atual</small>
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">${streak.current} üî•</div>
              </div>
              <div style="flex: 1;">
                <small style="color: var(--text-tertiary);">Melhor Sequ√™ncia</small>
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-purple);">${streak.max} ‚≠ê</div>
              </div>
            </div>
          </div>
        `;
      }).join('')}</div>`;
    },

    renderTasks: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <h1>Tarefas</h1>
            <button class="btn btn-primary" onclick="taskHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Tarefa
            </button>
          </div>

          <div id="tasks-list"></div>
        </div>
      `;

      this.renderTasksList();
    },

    renderTasksList: function() {
      const container = document.getElementById('tasks-list');
      const tasks = appState.tasks;

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">task_alt</span>
            <h3 class="empty-state-title">Nenhuma tarefa cadastrada</h3>
            <p class="empty-state-description">Crie sua primeira tarefa!</p>
          </div>
        `;
        return;
      }

      const todoTasks = tasks.filter(t => t.status === 'todo');
      const doingTasks = tasks.filter(t => t.status === 'doing');
      const doneTasks = tasks.filter(t => t.status === 'done');

      container.innerHTML = `
        <div class="grid grid-3">
          <div>
            <h3 style="margin-bottom: 16px;">üìã A Fazer (${todoTasks.length})</h3>
            <div class="grid gap-sm">
              ${todoTasks.map(t => this.renderTaskCard(t)).join('')}
            </div>
          </div>
          <div>
            <h3 style="margin-bottom: 16px;">‚ö° Em Andamento (${doingTasks.length})</h3>
            <div class="grid gap-sm">
              ${doingTasks.map(t => this.renderTaskCard(t)).join('')}
            </div>
          </div>
          <div>
            <h3 style="margin-bottom: 16px;">‚úÖ Conclu√≠do (${doneTasks.length})</h3>
            <div class="grid gap-sm">
              ${doneTasks.map(t => this.renderTaskCard(t)).join('')}
            </div>
          </div>
        </div>
      `;
    },

    renderTaskCard: function(task) {
      const priorityColors = {
        urgent: 'badge-urgent',
        high: 'badge-high',
        normal: 'badge-normal',
        low: 'badge-low'
      };

      return `
        <div class="card">
          <div class="flex-between mb-sm">
            <strong>${utils.sanitize(task.title)}</strong>
            <span class="badge ${priorityColors[task.priority] || 'badge-normal'}">${task.priority || 'normal'}</span>
          </div>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
            ${utils.sanitize(task.description || '')}
          </p>
          <div class="flex gap-sm">
            ${task.status !== 'done' ? `
              <button class="btn btn-sm btn-success" onclick="taskHandlers.setStatus('${task.id}', 'done')" style="flex: 1;">
                Concluir
              </button>
            ` : ''}
            <button class="btn btn-sm btn-secondary" onclick="taskHandlers.openEditModal('${task.id}')" style="flex: 1;">
              Editar
            </button>
          </div>
        </div>
      `;
    },

    renderKanban: function(container) {
      container.innerHTML = `
        <div>
          <h1>Kanban</h1>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">Visualiza√ß√£o em kanban das suas tarefas</p>
          <div id="kanban-board"></div>
        </div>
      `;

      this.renderKanbanBoard();
    },

    renderKanbanBoard: function() {
      const container = document.getElementById('kanban-board');
      const tasks = appState.tasks;

      const columns = [
        { id: 'todo', title: 'üìã A Fazer', tasks: tasks.filter(t => t.status === 'todo') },
        { id: 'doing', title: '‚ö° Em Andamento', tasks: tasks.filter(t => t.status === 'doing') },
        { id: 'done', title: '‚úÖ Conclu√≠do', tasks: tasks.filter(t => t.status === 'done') }
      ];

      container.innerHTML = `
        <div class="kanban-board">
          ${columns.map(col => `
            <div class="kanban-column">
              <div class="kanban-header">
                <span>${col.title}</span>
                <span class="kanban-count">${col.tasks.length}</span>
              </div>
              <div class="kanban-cards">
                ${col.tasks.length === 0 ? '<p style="color: var(--text-tertiary); text-align: center; padding: 20px;">Nenhuma tarefa</p>' : ''}
                ${col.tasks.map(task => `
                  <div class="kanban-card">
                    <div class="kanban-card-title">${utils.sanitize(task.title)}</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin: 6px 0;">
                      ${utils.sanitize(task.description || '')}
                    </p>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    },

    renderCalendar: function(container) {
      container.innerHTML = `
        <div>
          <h1>Calend√°rio</h1>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">Visualize suas rotinas e tarefas no calend√°rio</p>
          <div class="card">
            <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
              Funcionalidade de calend√°rio em desenvolvimento
            </p>
          </div>
        </div>
      `;
    },

    renderGoals: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <h1>Metas</h1>
            <button class="btn btn-primary" onclick="goalHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Meta
            </button>
          </div>

          <div id="goals-list"></div>
        </div>
      `;

      this.renderGoalsList();
    },

    renderGoalsList: function() {
      const container = document.getElementById('goals-list');
      const goals = appState.goals;

      if (goals.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">flag</span>
            <h3 class="empty-state-title">Nenhuma meta cadastrada</h3>
            <p class="empty-state-description">Defina suas primeiras metas!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `<div class="grid">${goals.map(goal => {
        const progress = ((goal.currentValue || 0) / goal.targetValue) * 100;
        const isComplete = progress >= 100;

        return `
          <div class="card ${isComplete ? 'glow-green' : 'glow-blue'}">
            <div class="flex-between mb-md">
              <h3>${utils.sanitize(goal.name)}</h3>
              ${isComplete ? '<span class="badge badge-low">‚úÖ Conclu√≠da</span>' : ''}
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">${utils.sanitize(goal.description || '')}</p>

            <div class="flex-between mb-sm">
              <span style="font-size: 24px; font-weight: 700;">${goal.currentValue || 0} / ${goal.targetValue}</span>
              <span style="font-size: 18px; font-weight: 600; color: var(--accent-blue);">${Math.round(progress)}%</span>
            </div>

            <div class="progress-bar">
              <div class="progress-fill ${isComplete ? 'success' : ''}" style="width: ${Math.min(progress, 100)}%"></div>
            </div>

            ${goal.deadline ? `
              <p style="font-size: 13px; color: var(--text-tertiary); margin-top: 12px;">
                üìÖ Prazo: ${utils.formatDate(goal.deadline)}
              </p>
            ` : ''}
          </div>
        `;
      }).join('')}</div>`;
    },

    renderSettings: function(container) {
      container.innerHTML = `
        <div>
          <h1>Configura√ß√µes</h1>

          <div class="card">
            <h3 class="mb-md">Apar√™ncia</h3>
            <div class="form-group">
              <label class="form-label">Tema</label>
              <select class="form-select" id="theme-select">
                <option value="light" ${appState.preferences.theme === 'light' ? 'selected' : ''}>Claro</option>
                <option value="dark" ${appState.preferences.theme === 'dark' ? 'selected' : ''}>Escuro</option>
              </select>
            </div>
          </div>

          <div class="card mt-md">
            <h3 class="mb-md">Conta</h3>
            <div class="flex-between">
              <div>
                <p style="color: var(--text-secondary); margin-bottom: 4px;">Usu√°rio conectado</p>
                <strong id="settings-user-email">${appState.userKey || 'Carregando...'}</strong>
              </div>
              <button class="btn btn-danger" onclick="authHandlers.logout()">Sair</button>
            </div>
          </div>

          <div class="card mt-md">
            <h3 class="mb-md">Dados</h3>
            <button class="btn btn-secondary w-full" onclick="settingsHandlers.exportData()">
              <span class="material-icons">download</span>
              Exportar Dados
            </button>
          </div>
        </div>
      `;

      const themeSelect = document.getElementById('theme-select');
      if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
          theme.apply(e.target.value);
          storage.save('theme', e.target.value);
        });
      }
    }
  };

  // ============================================
  // HANDLERS
  // ============================================

  const habitHandlers = {
    toggleToday: async function(habitId) {
      const today = utils.getTodayISO();
      const result = await api.toggleHabitCompletion(habitId, today);

      if (result.ok) {
        Object.assign(appState, result.data);
        router.render(appState.currentView);
        toast.success('Rotina atualizada!');
      } else {
        toast.error('Erro ao atualizar rotina: ' + result.error);
      }
    },

    openCreateModal: function() {
      toast.info('Funcionalidade em desenvolvimento');
    }
  };

  const taskHandlers = {
    setStatus: async function(taskId, status) {
      const result = await api.setTaskStatus(taskId, status);

      if (result.ok) {
        Object.assign(appState, result.data);
        router.render(appState.currentView);
        toast.success('Tarefa atualizada!');
      } else {
        toast.error('Erro ao atualizar tarefa: ' + result.error);
      }
    },

    openCreateModal: function() {
      toast.info('Funcionalidade em desenvolvimento');
    },

    openEditModal: function(taskId) {
      toast.info('Funcionalidade em desenvolvimento');
    }
  };

  const goalHandlers = {
    openCreateModal: function() {
      toast.info('Funcionalidade em desenvolvimento');
    }
  };

  const settingsHandlers = {
    exportData: async function() {
      toast.info('Exportando dados...');
      const result = await api.exportUserData('json');

      if (result.ok) {
        toast.success('Dados exportados com sucesso!');
      } else {
        toast.error('Erro ao exportar dados: ' + result.error);
      }
    }
  };

  const authHandlers = {
    logout: function() {
      if (confirm('Tem certeza que deseja sair?')) {
        storage.remove('appCache');
        storage.remove('theme');
        storage.remove('preferences');
        window.location.reload();
      }
    }
  };

  window.habitHandlers = habitHandlers;
  window.taskHandlers = taskHandlers;
  window.goalHandlers = goalHandlers;
  window.settingsHandlers = settingsHandlers;
  window.authHandlers = authHandlers;
  window.router = router;
  window.utils = utils;
  window.toast = toast;
  window.api = api;

  // ============================================
  // INITIALIZATION
  // ============================================

  document.addEventListener('DOMContentLoaded', async function() {
    theme.init();
    
    const loadingScreen = document.getElementById('loading-screen');
    const appContainer = document.getElementById('app');
    
    try {
      const result = await api.initApp();
      
      if (result.ok) {
        Object.assign(appState, result.data);
        storage.save('appCache', appState);
        
        if (appContainer) {
          appContainer.style.display = '';
        }
        if (loadingScreen) {
          loadingScreen.style.display = 'none';
        }
        
        router.init();
      } else {
        toast.error('Erro ao carregar aplica√ß√£o: ' + (result.error || 'Desconhecido'));
      }
    } catch (error) {
      console.error('Erro na inicializa√ß√£o:', error);
      toast.error('Erro ao inicializar aplica√ß√£o');
    }
  });

})();
</script>
