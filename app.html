<script>
// ============================================
// ROUTINE APP - Frontend JavaScript
// ============================================

(function() {
  'use strict';

  // ============================================
  // DIAGNOSTICS
  // ============================================

  const diagnostics = {
    lastCall: null,
    lastResponse: null,
    lastError: null,
    history: []
  };

  function recordDiagnostic(type, data) {
    const entry = { type, data, timestamp: new Date().toISOString() };
    if (type === 'call') diagnostics.lastCall = entry;
    if (type === 'response') diagnostics.lastResponse = entry;
    if (type === 'error') diagnostics.lastError = entry;
    diagnostics.history.unshift(entry);
    if (diagnostics.history.length > 50) diagnostics.history = diagnostics.history.slice(0, 50);
  }

  window.diagnostics = diagnostics;

  // ============================================
  // STATE MANAGEMENT
  // ============================================
  
  const appState = {
    userKey: null,
    habits: [],
    habitLogs: [],
    tasks: [],
    taskChecklists: [],
    goals: [],
    goalLogs: [],
    journals: [],
    currentView: 'dashboard',
    isLoading: false,
    isOffline: false,
    preferences: {
      theme: 'dark',
      weekStart: 'monday',
      timeFormat: '24h',
      reduceAnimations: false
    }
  };

  // ============================================
  // UTILITIES
  // ============================================

  const utils = {
    sanitize: function(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    },
    
    formatDate: function(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('pt-BR');
    },
    
    getTodayISO: function() {
      return new Date().toISOString().split('T')[0];
    },
    
    daysBetween: function(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      const diff = Math.abs(d2 - d1);
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    },
    
    calculateStreak: function(logs, habitId) {
      const sortedLogs = logs
        .filter(l => l.habitId === habitId && l.completed)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (sortedLogs.length === 0) return { current: 0, max: 0 };
      
      let currentStreak = 0;
      let maxStreak = 0;
      let tempStreak = 0;
      let expectedDate = new Date(this.getTodayISO());
      
      for (let i = 0; i < sortedLogs.length; i++) {
        const logDate = new Date(sortedLogs[i].date);
        
        if (i === 0) {
          const daysDiff = this.daysBetween(logDate, expectedDate);
          if (daysDiff <= 1) {
            currentStreak = 1;
            tempStreak = 1;
          }
        }
        
        if (i > 0) {
          const prevDate = new Date(sortedLogs[i-1].date);
          const daysDiff = this.daysBetween(logDate, prevDate);
          
          if (daysDiff === 1) {
            tempStreak++;
            if (i === 0 || currentStreak > 0) {
              currentStreak = tempStreak;
            }
          } else {
            tempStreak = 1;
            currentStreak = 0;
          }
        }
        
        maxStreak = Math.max(maxStreak, tempStreak);
      }
      
      return { current: currentStreak, max: maxStreak };
    },
    
    debounce: function(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },
    
    generateTempId: function() {
      return 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
  };

  // ============================================
  // LOCAL STORAGE
  // ============================================

  const storage = {
    save: function(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e) {
        console.error('Error saving to localStorage:', e);
      }
    },
    
    load: function(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('Error loading from localStorage:', e);
        return null;
      }
    },
    
    remove: function(key) {
      try {
        localStorage.removeItem(key);
      } catch (e) {
        console.error('Error removing from localStorage:', e);
      }
    }
  };

  // ============================================
  // TOAST NOTIFICATIONS
  // ============================================

  const toast = {
    show: function(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      
      const icons = {
        success: 'check_circle',
        error: 'error',
        info: 'info'
      };
      
      toastEl.innerHTML = `
        <span class="material-icons toast-icon">${icons[type] || 'info'}</span>
        <div class="toast-content">
          <div class="toast-message">${utils.sanitize(message)}</div>
        </div>
      `;
      
      container.appendChild(toastEl);
      
      setTimeout(() => {
        toastEl.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toastEl.remove(), 300);
      }, duration);
    },
    
    success: function(message) {
      this.show(message, 'success');
    },
    
    error: function(message) {
      this.show(message, 'error', 4000);
    },
    
    info: function(message) {
      this.show(message, 'info');
    }
  };

  // ============================================
  // MODAL
  // ============================================

  const modal = {
    open: function(title, content, actions = []) {
      const container = document.getElementById('modal-container');
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const actionsHTML = actions.map(action => {
        const btnClass = action.primary ? 'btn-primary' : 'btn-secondary';
        return `<button class="btn ${btnClass}" onclick="${action.onclick}">${action.label}</button>`;
      }).join('');
      
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">${utils.sanitize(title)}</h2>
            <button class="modal-close" onclick="modal.close()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          ${actions.length > 0 ? `
            <div class="modal-footer">
              ${actionsHTML}
            </div>
          ` : ''}
        </div>
      `;
      
      container.innerHTML = '';
      container.appendChild(overlay);
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          this.close();
        }
      });
    },
    
    close: function() {
      const container = document.getElementById('modal-container');
      container.innerHTML = '';
    }
  };

  window.modal = modal;

  // ============================================
  // API CALLS
  // ============================================

  const api = {
    call: function(functionName, ...args) {
      return new Promise((resolve) => {
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.error('google.script.run não está disponível');
            resolve({ ok: false, error: 'Ambiente de execução não disponível' });
            return;
          }
          
          google.script.run
            .withSuccessHandler((result) => {
              if (result === null || result === undefined) {
                resolve({ ok: false, error: 'Resposta vazia do servidor' });
              } else {
                resolve(result);
              }
            })
            .withFailureHandler((error) => {
              console.error('Erro na chamada API:', error);
              resolve({ ok: false, error: error.message || error.toString() });
            })
            [functionName](...args);
        } catch (error) {
          console.error('Erro ao chamar API:', error);
          resolve({ ok: false, error: error.message || 'Erro desconhecido' });
        }
      });
    },
    
    initApp: async function(userKey) {
      return await this.call('initApp', userKey);
    },
    
    createHabit: async function(habitData) {
      return await this.call('createHabit', appState.userKey, habitData);
    },
    
    updateHabit: async function(habitId, updates) {
      return await this.call('updateHabit', appState.userKey, habitId, updates);
    },
    
    deleteHabit: async function(habitId) {
      return await this.call('deleteHabit', appState.userKey, habitId);
    },
    
    toggleHabitCompletion: async function(habitId, date) {
      return await this.call('toggleHabitCompletion', appState.userKey, habitId, date);
    },
    
    createTask: async function(taskData) {
      return await this.call('createTask', appState.userKey, taskData);
    },
    
    updateTask: async function(taskId, updates) {
      return await this.call('updateTask', appState.userKey, taskId, updates);
    },
    
    deleteTask: async function(taskId) {
      return await this.call('deleteTask', appState.userKey, taskId);
    },
    
    setTaskStatus: async function(taskId, status) {
      return await this.call('setTaskStatus', appState.userKey, taskId, status);
    },
    
    addChecklistItem: async function(taskId, text) {
      return await this.call('addChecklistItem', appState.userKey, taskId, text);
    },
    
    toggleChecklistItem: async function(itemId) {
      return await this.call('toggleChecklistItem', appState.userKey, itemId);
    },
    
    deleteChecklistItem: async function(itemId) {
      return await this.call('deleteChecklistItem', appState.userKey, itemId);
    },
    
    createGoal: async function(goalData) {
      return await this.call('createGoal', appState.userKey, goalData);
    },
    
    updateGoal: async function(goalId, updates) {
      return await this.call('updateGoal', appState.userKey, goalId, updates);
    },
    
    deleteGoal: async function(goalId) {
      return await this.call('deleteGoal', appState.userKey, goalId);
    },
    
    addGoalProgress: async function(goalId, delta, note, date) {
      return await this.call('addGoalProgress', appState.userKey, goalId, delta, note, date);
    },

    exportUserData: async function(format) {
      return await this.call('exportUserData', appState.userKey, format);
    }
  };

  // ============================================
  // THEME MANAGEMENT
  // ============================================

  const theme = {
    init: function() {
      const savedTheme = storage.load('theme') || 'dark';
      this.apply(savedTheme);
      
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          this.apply(newTheme);
          appState.preferences.theme = newTheme;
          storage.save('theme', newTheme);
          storage.save('preferences', appState.preferences);
        });
      }
    },
    
    apply: function(themeName) {
      document.documentElement.setAttribute('data-theme', themeName);
      appState.preferences.theme = themeName;
    }
  };

  // ============================================
  // ROUTER
  // ============================================

  const router = {
    init: function() {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const view = item.getAttribute('data-view');
          this.navigate(view);
        });
      });
      
      window.addEventListener('hashchange', () => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        this.navigate(hash);
      });
      
      const initialView = window.location.hash.slice(1) || 'dashboard';
      this.navigate(initialView);
    },
    
    navigate: function(view) {
      appState.currentView = view;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-view') === view) {
          item.classList.add('active');
        }
      });
      
      this.render(view);
      window.location.hash = view;
    },
    
    render: function(view) {
      const container = document.getElementById('view-container');
      
      switch(view) {
        case 'dashboard':
          views.renderDashboard(container);
          break;
        case 'habits':
          views.renderHabits(container);
          break;
        case 'tasks':
          views.renderTasks(container);
          break;
        case 'kanban':
          views.renderKanban(container);
          break;
        case 'calendar':
          views.renderCalendar(container);
          break;
        case 'goals':
          views.renderGoals(container);
          break;
        case 'settings':
          views.renderSettings(container);
          break;
        default:
          views.renderDashboard(container);
      }
    }
  };

  // ============================================
  // VIEWS (Placeholder - Full implementation in original)
  // ============================================

  const views = {
    renderDashboard: function(container) {
      container.innerHTML = '<div><h1>Dashboard</h1><p>Carregando...</p></div>';
    },
    renderHabits: function(container) {
      container.innerHTML = '<div><h1>Rotinas</h1><p>Carregando...</p></div>';
    },
    renderTasks: function(container) {
      container.innerHTML = '<div><h1>Tarefas</h1><p>Carregando...</p></div>';
    },
    renderKanban: function(container) {
      container.innerHTML = '<div><h1>Kanban</h1><p>Carregando...</p></div>';
    },
    renderCalendar: function(container) {
      container.innerHTML = '<div><h1>Calendário</h1><p>Carregando...</p></div>';
    },
    renderGoals: function(container) {
      container.innerHTML = '<div><h1>Metas</h1><p>Carregando...</p></div>';
    },
    renderSettings: function(container) {
      container.innerHTML = '<div><h1>Configurações</h1><p>Carregando...</p></div>';
    }
  };

  // ============================================
  // HANDLERS
  // ============================================

  const habitHandlers = {};
  const taskHandlers = {};
  const goalHandlers = {};
  const settingsHandlers = {};
  const authHandlers = {
    logout: function() {
      if (confirm('Tem certeza que deseja sair?')) {
        window.location.reload();
      }
    }
  };

  window.habitHandlers = habitHandlers;
  window.taskHandlers = taskHandlers;
  window.goalHandlers = goalHandlers;
  window.settingsHandlers = settingsHandlers;
  window.authHandlers = authHandlers;
  window.router = router;
  window.utils = utils;
  window.toast = toast;
  window.api = api;

  // ============================================
  // INITIALIZATION
  // ============================================

  document.addEventListener('DOMContentLoaded', async function() {
    theme.init();
    
    const loadingScreen = document.getElementById('loading-screen');
    const appContainer = document.getElementById('app');
    
    try {
      const result = await api.initApp();
      
      if (result.ok) {
        Object.assign(appState, result.data);
        storage.save('appCache', appState);
        
        if (appContainer) {
          appContainer.style.display = '';
        }
        if (loadingScreen) {
          loadingScreen.style.display = 'none';
        }
        
        router.init();
      } else {
        toast.error('Erro ao carregar aplicação: ' + (result.error || 'Desconhecido'));
      }
    } catch (error) {
      console.error('Erro na inicialização:', error);
      toast.error('Erro ao inicializar aplicação');
    }
  });

})();
</script>
