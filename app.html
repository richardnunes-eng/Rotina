<script>
// ============================================
// ROUTINE APP - Frontend JavaScript
// ============================================

(function() {
  'use strict';

  if (typeof window === 'undefined') {
    return;
  }

  // ============================================
  // DIAGNOSTICS
  // ============================================

  const diagnostics = {
    lastCall: null,
    lastResponse: null,
    lastError: null,
    history: []
  };

  function recordDiagnostic(type, data) {
    const entry = { type, data, timestamp: new Date().toISOString() };
    if (type === 'call') diagnostics.lastCall = entry;
    if (type === 'response') diagnostics.lastResponse = entry;
    if (type === 'error') diagnostics.lastError = entry;
    diagnostics.history.unshift(entry);
    if (diagnostics.history.length > 50) diagnostics.history = diagnostics.history.slice(0, 50);
  }

  window.diagnostics = diagnostics;

  // ============================================
  // STATE MANAGEMENT
  // ============================================
  
  const appState = {
    userKey: null,
    habits: [],
    habitLogs: [],
    tasks: [],
    taskChecklists: [],
    goals: [],
    goalLogs: [],
    focusLogs: [],
    journals: [],
    currentView: 'dashboard',
    isLoading: false,
    isOffline: false,
    preferences: {
      theme: 'dark',
      weekStart: 'monday',
      timeFormat: '24h',
      reduceAnimations: false
    },
    focus: {
      taskId: '',
      remainingSeconds: 1500,
      isRunning: false
    }
  };

  // Cache de performance para otimizar cÃ¡lculos pesados
  const perfCache = {
    streaks: new Map(),
    heatmapData: null,
    filteredHabits: null,
    filteredTasks: null,
    lastCacheTime: Date.now(),

    invalidate: function() {
      this.streaks.clear();
      this.heatmapData = null;
      this.filteredHabits = null;
      this.filteredTasks = null;
      this.lastCacheTime = Date.now();
    },

    getStreak: function(habitId, logs) {
      const cacheKey = `${habitId}_${logs.length}`;
      if (this.streaks.has(cacheKey)) {
        return this.streaks.get(cacheKey);
      }
      const streak = utils.calculateStreak(logs, habitId);
      this.streaks.set(cacheKey, streak);
      return streak;
    }
  };

  function applyFullState(nextState) {
    if (!nextState) return;
    appState.userKey = nextState.userKey || appState.userKey;
    appState.habits = Array.isArray(nextState.habits) ? nextState.habits : [];
    appState.habitLogs = Array.isArray(nextState.habitLogs) ? nextState.habitLogs : [];
    appState.tasks = Array.isArray(nextState.tasks) ? nextState.tasks : [];
    appState.taskChecklists = Array.isArray(nextState.taskChecklists) ? nextState.taskChecklists : [];
    appState.goals = Array.isArray(nextState.goals) ? nextState.goals : [];
    appState.goalLogs = Array.isArray(nextState.goalLogs) ? nextState.goalLogs : [];
    appState.focusLogs = Array.isArray(nextState.focusLogs) ? nextState.focusLogs : [];
    appState.journals = Array.isArray(nextState.journals) ? nextState.journals : [];

    // Invalidar cache quando os dados mudarem
    perfCache.invalidate();
  }

  // Debounce para refreshUI
  let refreshTimeout = null;
  function refreshUI() {
    // Invalidar cache de performance
    perfCache.invalidate();

    // Debounce para evitar mÃºltiplas renderizaÃ§Ãµes
    if (refreshTimeout) {
      clearTimeout(refreshTimeout);
    }

    refreshTimeout = setTimeout(() => {
      // ForÃ§ar re-renderizaÃ§Ã£o da view atual
      requestAnimationFrame(() => {
        router.render(appState.currentView);
        notifications.refreshBadge();
      });
      refreshTimeout = null;
    }, 50);
  }

  // ============================================
  // UTILITIES
  // ============================================

  const utils = {
    sanitize: function(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    },

    // ValidaÃ§Ãµes
    validateRequired: function(value, fieldName) {
      if (!value || String(value).trim() === '') {
        toast.error(`${fieldName} Ã© obrigatÃ³rio`);
        return false;
      }
      return true;
    },

    validateNumber: function(value, fieldName, min = null, max = null) {
      const num = parseFloat(value);
      if (isNaN(num)) {
        toast.error(`${fieldName} deve ser um nÃºmero vÃ¡lido`);
        return false;
      }
      if (min !== null && num < min) {
        toast.error(`${fieldName} deve ser maior ou igual a ${min}`);
        return false;
      }
      if (max !== null && num > max) {
        toast.error(`${fieldName} deve ser menor ou igual a ${max}`);
        return false;
      }
      return true;
    },

    validateDate: function(dateStr, fieldName, allowPast = true) {
      if (!dateStr) return true; // Opcional
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) {
        toast.error(`${fieldName} invÃ¡lida`);
        return false;
      }
      if (!allowPast) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (date < today) {
          toast.error(`${fieldName} nÃ£o pode ser no passado`);
          return false;
        }
      }
      return true;
    },

    validateTime: function(timeStr, fieldName) {
      if (!timeStr) return true; // Opcional
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (!timeRegex.test(timeStr)) {
        toast.error(`${fieldName} invÃ¡lido. Use formato HH:MM`);
        return false;
      }
      return true;
    },
    
    formatDate: function(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('pt-BR');
    },

    formatTime: function(timeStr) {
      if (!timeStr) return '';
      return String(timeStr).slice(0, 5);
    },

    formatRelativeDate: function(dateStr) {
      if (!dateStr) return '';
      const today = this.getTodayISO();
      if (dateStr === today) return 'Hoje';
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowISO = tomorrow.toISOString().split('T')[0];
      if (dateStr === tomorrowISO) return 'AmanhÃ£';
      return this.formatDate(dateStr);
    },
    
    getTodayISO: function() {
      return new Date().toISOString().split('T')[0];
    },
    
    daysBetween: function(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      const diff = Math.abs(d2 - d1);
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    },
    
    calculateStreak: function(logs, habitId) {
      const sortedLogs = logs
        .filter(l => l.habitId === habitId && l.completed)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (sortedLogs.length === 0) return { current: 0, max: 0 };
      
      let currentStreak = 0;
      let maxStreak = 0;
      let tempStreak = 0;
      let expectedDate = new Date(this.getTodayISO());
      
      for (let i = 0; i < sortedLogs.length; i++) {
        const logDate = new Date(sortedLogs[i].date);
        
        if (i === 0) {
          const daysDiff = this.daysBetween(logDate, expectedDate);
          if (daysDiff <= 1) {
            currentStreak = 1;
            tempStreak = 1;
          }
        }
        
        if (i > 0) {
          const prevDate = new Date(sortedLogs[i-1].date);
          const daysDiff = this.daysBetween(logDate, prevDate);
          
          if (daysDiff === 1) {
            tempStreak++;
            if (i === 0 || currentStreak > 0) {
              currentStreak = tempStreak;
            }
          } else {
            tempStreak = 1;
            currentStreak = 0;
          }
        }
        
        maxStreak = Math.max(maxStreak, tempStreak);
      }
      
      return { current: currentStreak, max: maxStreak };
    },
    
    debounce: function(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },
    
    generateTempId: function() {
      return 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
  };

  // ============================================
  // LOCAL STORAGE
  // ============================================

  const storage = {
    save: function(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e) {
        console.error('Error saving to localStorage:', e);
      }
    },
    
    load: function(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('Error loading from localStorage:', e);
        return null;
      }
    },
    
    remove: function(key) {
      try {
        localStorage.removeItem(key);
      } catch (e) {
        console.error('Error removing from localStorage:', e);
      }
    }
  };

  // ============================================
  // GLOBAL LOADING STATE
  // ============================================

  const globalLoading = {
    activeOps: 0,

    start: function() {
      this.activeOps++;
      appState.isLoading = true;
    },

    end: function() {
      this.activeOps = Math.max(0, this.activeOps - 1);
      if (this.activeOps === 0) {
        appState.isLoading = false;
      }
    },

    isActive: function() {
      return this.activeOps > 0;
    }
  };

  // ============================================
  // TOAST NOTIFICATIONS
  // ============================================

  const toast = {
    show: function(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      
      const icons = {
        success: 'check_circle',
        error: 'error',
        info: 'info'
      };
      
      toastEl.innerHTML = `
        <span class="material-icons toast-icon">${icons[type] || 'info'}</span>
        <div class="toast-content">
          <div class="toast-message">${utils.sanitize(message)}</div>
        </div>
      `;
      
      container.appendChild(toastEl);
      
      setTimeout(() => {
        toastEl.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toastEl.remove(), 300);
      }, duration);
    },
    
    success: function(message) {
      this.show(message, 'success');
    },
    
    error: function(message) {
      this.show(message, 'error', 4000);
    },
    
    info: function(message) {
      this.show(message, 'info');
    }
  };

  // ============================================
  // NOTIFICATIONS
  // ============================================

  const notifications = {
    getReadMap: function() {
      return storage.load('notificationsRead') || {};
    },

    saveReadMap: function(map) {
      storage.save('notificationsRead', map || {});
    },

    buildItems: function() {
      const items = [];
      const today = utils.getTodayISO();
      const activeHabits = appState.habits.filter(h => h.active !== false);

      const overdueTasks = appState.tasks.filter(t => t.status !== 'done' && t.dueDate && t.dueDate < today);
      overdueTasks.forEach(task => {
        items.push({
          id: `task-overdue-${task.id}`,
          type: 'task',
          title: 'Tarefa atrasada',
          message: task.title || 'Sem titulo',
          timestamp: task.dueDate || today,
          action: { label: 'Ver tarefas', view: 'tasks' }
        });
      });

      const dueTodayTasks = appState.tasks.filter(t => t.status !== 'done' && t.dueDate === today);
      dueTodayTasks.forEach(task => {
        items.push({
          id: `task-due-${task.id}`,
          type: 'task',
          title: 'Tarefa para hoje',
          message: task.title || 'Sem titulo',
          timestamp: task.dueDate || today,
          action: { label: 'Abrir agenda', view: 'agenda' }
        });
      });

      if (activeHabits.length > 0) {
        const completedIds = new Set(appState.habitLogs.filter(l => l.date === today && l.completed).map(l => l.habitId));
        const pendingHabits = activeHabits.filter(h => !completedIds.has(h.id));
        if (pendingHabits.length > 0) {
          items.push({
            id: `habit-pending-${today}`,
            type: 'habit',
            title: 'Rotinas pendentes hoje',
            message: `${pendingHabits.length} rotina(s) aguardando`,
            timestamp: today,
            action: { label: 'Ver rotinas', view: 'habits' }
          });
        }
      }

      const goalsOverdue = appState.goals.filter(g => g.status !== 'completed' && g.dueDate && g.dueDate < today);
      goalsOverdue.forEach(goal => {
        items.push({
          id: `goal-overdue-${goal.id}`,
          type: 'goal',
          title: 'Meta atrasada',
          message: goal.title || 'Sem titulo',
          timestamp: goal.dueDate || today,
          action: { label: 'Ver metas', view: 'goals' }
        });
      });

      items.sort((a, b) => {
        const aVal = new Date(a.timestamp || today).getTime();
        const bVal = new Date(b.timestamp || today).getTime();
        return bVal - aVal;
      });

      return items;
    },

    isRead: function(id) {
      const map = this.getReadMap();
      return !!map[id];
    },

    markRead: function(id) {
      const map = this.getReadMap();
      map[id] = new Date().toISOString();
      this.saveReadMap(map);
    },

    markAllRead: function(items) {
      const map = this.getReadMap();
      (items || []).forEach(item => {
        map[item.id] = new Date().toISOString();
      });
      this.saveReadMap(map);
    },

    getUnreadCount: function(items) {
      const list = items || this.buildItems();
      return list.filter(item => !this.isRead(item.id)).length;
    },

    refreshBadge: function(items) {
      const count = this.getUnreadCount(items);
      const badge = document.getElementById('notifications-count');
      const badgeMobile = document.getElementById('notifications-count-mobile');
      if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
      if (badgeMobile) {
        badgeMobile.textContent = count;
        badgeMobile.style.display = count > 0 ? 'inline-flex' : 'none';
      }
    }
  };

  // ============================================
  // MODAL
  // ============================================

  const modal = {
    open: function(title, content, actions = []) {
      const container = document.getElementById('modal-container');
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const actionsHTML = actions.map(action => {
        const btnClass = action.primary ? 'btn-primary' : 'btn-secondary';
        return `<button class="btn ${btnClass}" onclick="${action.onclick}">${action.label}</button>`;
      }).join('');
      
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">${utils.sanitize(title)}</h2>
            <button class="modal-close" onclick="modal.close()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          ${actions.length > 0 ? `
            <div class="modal-footer">
              ${actionsHTML}
            </div>
          ` : ''}
        </div>
      `;
      
      container.innerHTML = '';
      container.appendChild(overlay);
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          this.close();
        }
      });
    },
    
    close: function() {
      const container = document.getElementById('modal-container');
      container.innerHTML = '';
    }
  };

  window.modal = modal;

  // ============================================
  // API CALLS
  // ============================================

  const api = {
    call: function(functionName, ...args) {
      globalLoading.start();

      return new Promise((resolve) => {
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.error('google.script.run nÃ£o estÃ¡ disponÃ­vel');
            globalLoading.end();
            resolve({ ok: false, error: 'Ambiente de execuÃ§Ã£o nÃ£o disponÃ­vel' });
            return;
          }

          // Timeout de 15 segundos
          const timeoutId = setTimeout(() => {
            console.error('Timeout na chamada:', functionName);
            globalLoading.end();
            resolve({ ok: false, error: 'A operaÃ§Ã£o demorou muito tempo. Tente novamente.' });
          }, 15000);

          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              globalLoading.end();
              if (result === null || result === undefined) {
                resolve({ ok: false, error: 'O servidor retornou uma resposta vazia. Verifique as configuraÃ§Ãµes e tente novamente.' });
              } else {
                resolve(result);
              }
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              globalLoading.end();
              console.error('Erro na chamada API:', error);
              const errorMsg = error.message || error.toString();
              resolve({ ok: false, error: errorMsg });
            })
            [functionName](...args);
        } catch (error) {
          console.error('Erro ao chamar API:', error);
          globalLoading.end();
          resolve({ ok: false, error: error.message || 'Erro desconhecido' });
        }
      });
    },
    
    initApp: async function(userKey) {
      return await this.call('initApp', userKey);
    },
    
    createHabit: async function(habitData) {
      return await this.call('createHabit', appState.userKey, habitData);
    },

    updateHabit: async function(habitId, updates) {
      return await this.call('updateHabit', appState.userKey, habitId, updates);
    },

    deleteHabit: async function(habitId) {
      return await this.call('deleteHabit', appState.userKey, habitId);
    },

    // Tasks API
    createTask: async function(taskData) {
      return await this.call('createTask', appState.userKey, taskData);
    },

    updateTask: async function(taskId, updates) {
      return await this.call('updateTask', appState.userKey, taskId, updates);
    },

    deleteTask: async function(taskId) {
      return await this.call('deleteTask', appState.userKey, taskId);
    },

    toggleTaskStatus: async function(taskId) {
      return await this.call('toggleTaskStatus', appState.userKey, taskId);
    },

    setTaskStatus: async function(taskId, status) {
      return await this.call('setTaskStatus', appState.userKey, taskId, status);
    },

    // Goals API
    createGoal: async function(goalData) {
      return await this.call('createGoal', appState.userKey, goalData);
    },

    updateGoal: async function(goalId, updates) {
      return await this.call('updateGoal', appState.userKey, goalId, updates);
    },

    deleteGoal: async function(goalId) {
      return await this.call('deleteGoal', appState.userKey, goalId);
    },

    updateGoalProgress: async function(goalId, newValue) {
      return await this.call('updateGoalProgress', appState.userKey, goalId, newValue);
    },

    addGoalProgress: async function(goalId, delta, note, date) {
      return await this.call('addGoalProgress', appState.userKey, goalId, delta, note, date);
    },

    // Habit Logs API
    logHabit: async function(habitId, date, completed) {
      return await this.call('logHabit', appState.userKey, habitId, date, completed);
    },

    toggleHabitCompletion: async function(habitId, date) {
      return await this.call('toggleHabitCompletion', appState.userKey, habitId, date);
    },

    // ClickUp API
    listClickUpTasks: async function(params) {
      return await this.call('listClickUpTasks', params);
    },

    syncClickUp: async function() {
      return await this.call('syncClickUp', appState.userKey);
    },

    getClickUpStatus: async function() {
      return await this.call('getClickUpStatus', appState.userKey);
    }
  };

  // ============================================
  // THEME MANAGEMENT
  // ============================================

  const theme = {
    init: function() {
      const savedTheme = storage.load('theme') || 'dark';
      this.apply(savedTheme);
      
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          this.apply(newTheme);
          appState.preferences.theme = newTheme;
          storage.save('theme', newTheme);
          storage.save('preferences', appState.preferences);
        });
      }
    },
    
    apply: function(themeName) {
      document.documentElement.setAttribute('data-theme', themeName);
      appState.preferences.theme = themeName;
    }
  };

  // ============================================
  // ROUTER
  // ============================================

  const router = {
    init: function() {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const view = item.getAttribute('data-view');
          this.navigate(view);
        });
      });
      
      window.addEventListener('hashchange', () => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        this.navigate(hash);
      });
      
      const initialView = window.location.hash.slice(1) || 'dashboard';
      this.navigate(initialView);
    },
    
    navigate: function(view) {
      appState.currentView = view;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-view') === view) {
          item.classList.add('active');
        }
      });
      
      this.render(view);
      window.location.hash = view;
    },
    
    render: function(view) {
      const container = document.getElementById('view-container');
      
      switch(view) {
        case 'dashboard':
          views.renderDashboard(container);
          break;
        case 'habits':
          views.renderHabits(container);
          break;
        case 'tasks':
          views.renderTasks(container);
          break;
        case 'kanban':
          views.renderKanban(container);
          break;
        case 'calendar':
          views.renderCalendar(container);
          break;
        case 'agenda':
          views.renderAgenda(container);
          break;
        case 'goals':
          views.renderGoals(container);
          break;
        case 'focus':
          views.renderFocus(container);
          break;
        case 'reports':
          views.renderReports(container);
          break;
        case 'notifications':
          views.renderNotifications(container);
          break;
        case 'clickup':
          views.renderClickUp(container);
          break;
        case 'settings':
          views.renderSettings(container);
          break;
        default:
          views.renderDashboard(container);
      }
    }
  };

  // ============================================
  // VIEWS - Full Implementation
  // ============================================

  const views = {
    renderDashboard: function(container) {
      const today = utils.getTodayISO();

      // Otimizar: fazer todas as contagens em uma Ãºnica passagem
      let completedHabitsToday = 0;
      let totalHabits = 0;
      let activeTasks = 0;
      let dueToday = 0;
      let overdue = 0;
      let currentStreak = 0;

      // Processar hÃ¡bitos
      appState.habits.forEach(h => {
        if (h.active !== false) {
          totalHabits++;
          const streak = perfCache.getStreak(h.id, appState.habitLogs);
          currentStreak = Math.max(currentStreak, streak.current);
        }
      });

      // Processar logs de hoje
      appState.habitLogs.forEach(log => {
        if (log.date === today && log.completed) {
          completedHabitsToday++;
        }
      });

      // Processar tarefas
      appState.tasks.forEach(t => {
        if (t.status !== 'done') {
          activeTasks++;
          if (t.dueDate && t.dueDate < today) {
            overdue++;
          } else if (t.dueDate === today) {
            dueToday++;
          }
        }
      });

      const agendaItems = this.getAgendaItems(today);

      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>Dashboard</h1>
              <span>Centro de comando do seu dia.</span>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-primary" onclick="habitHandlers.openCreateModal()">+ Rotina</button>
              <button class="btn btn-secondary" onclick="taskHandlers.openCreateModal()">+ Tarefa</button>
              <button class="btn btn-secondary" onclick="goalHandlers.openCreateModal()">+ Meta</button>
            </div>
          </div>

          <div class="kpi-grid">
            <div class="kpi-card glow-blue">
              <div class="kpi-label">Rotinas Hoje</div>
              <div class="kpi-value">${completedHabitsToday}/${totalHabits}</div>
              <div class="kpi-change">${Math.round((completedHabitsToday/totalHabits)*100) || 0}% concluido</div>
            </div>

            <div class="kpi-card glow-orange">
              <div class="kpi-label">Tarefas Ativas</div>
              <div class="kpi-value">${activeTasks}</div>
              <div class="kpi-change">${dueToday} para hoje</div>
            </div>

            <div class="kpi-card glow-green">
              <div class="kpi-label">Streak Atual</div>
              <div class="kpi-value">${currentStreak}</div>
              <div class="kpi-change">Maior sequencia</div>
            </div>

            <div class="kpi-card glow-purple">
              <div class="kpi-label">Atrasadas</div>
              <div class="kpi-value">${overdue}</div>
              <div class="kpi-change">Prioridade hoje</div>
            </div>
          </div>

          <div class="quick-actions">
            <div class="quick-action" onclick="router.navigate('agenda')">
              <div class="quick-action-icon"><span class="material-icons">schedule</span></div>
              <div>
                <strong>Agenda do dia</strong>
                <div style="font-size: 13px; color: var(--text-secondary);">Veja sua linha do tempo</div>
              </div>
            </div>
            <div class="quick-action" onclick="router.navigate('focus')">
              <div class="quick-action-icon"><span class="material-icons">center_focus_strong</span></div>
              <div>
                <strong>Iniciar foco</strong>
                <div style="font-size: 13px; color: var(--text-secondary);">Sessao de 25 min</div>
              </div>
            </div>
            <div class="quick-action" onclick="taskHandlers.openCreateModal()">
              <div class="quick-action-icon"><span class="material-icons">add_task</span></div>
              <div>
                <strong>Quick add</strong>
                <div style="font-size: 13px; color: var(--text-secondary);">Tarefa imediata</div>
              </div>
            </div>
          </div>

          <div class="card mt-lg">
            <div class="card-header">
              <h2 class="card-title">Agenda de hoje</h2>
              <a href="#agenda" class="btn btn-sm btn-primary">Abrir agenda</a>
            </div>
            ${agendaItems.length === 0 ? '<div class="empty-state"><p>Nada agendado. Que tal planejar?</p></div>' : `
              <div class="timeline">
                ${agendaItems.slice(0, 6).map(item => `
                  <div class="timeline-row">
                    <div class="timeline-time">${item.time ? utils.formatTime(item.time) : 'Livre'}</div>
                    <div class="timeline-card">
                      <div>
                        <strong>${utils.sanitize(item.title)}</strong>
                        <div style="font-size: 12px; color: var(--text-secondary);">${utils.sanitize(item.meta)}</div>
                      </div>
                      <span class="badge">${item.type}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>

          <div class="card mt-lg">
            <div class="card-header">
              <h2 class="card-title">Heatmap de habitos</h2>
              <span class="chip">Ultimos 90 dias</span>
            </div>
            <div id="dashboard-heatmap">
              <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                <span class="material-icons" style="font-size: 32px; opacity: 0.5;">hourglass_empty</span>
                <p style="margin-top: 8px;">Carregando heatmap...</p>
              </div>
            </div>
          </div>

          <div class="card mt-lg">
            <div class="card-header">
              <h2 class="card-title">Rotinas de hoje</h2>
              <a href="#habits" class="btn btn-sm btn-primary">Ver todas</a>
            </div>
            <div id="dashboard-habits-list">
              <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                <span class="material-icons rotating">sync</span>
              </div>
            </div>
          </div>

          <div class="card mt-md">
            <div class="card-header">
              <h2 class="card-title">Tarefas recentes</h2>
              <a href="#tasks" class="btn btn-sm btn-primary">Ver todas</a>
            </div>
            <div id="dashboard-tasks-list">
              <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                <span class="material-icons rotating">sync</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Renderizar de forma assÃ­ncrona para nÃ£o bloquear a UI
      requestAnimationFrame(() => {
        this.renderDashboardHabits();
      });

      requestAnimationFrame(() => {
        this.renderDashboardTasks();
      });

      // Lazy load do heatmap usando Intersection Observer
      const heatmapContainer = document.getElementById('dashboard-heatmap');
      if (heatmapContainer) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                heatmapContainer.innerHTML = this.renderHeatmap();
              }, 50);
              observer.disconnect();
            }
          });
        }, { rootMargin: '100px' });

        observer.observe(heatmapContainer);
      }
    },

    renderDashboardHabits: function() {
      const container = document.getElementById('dashboard-habits-list');
      const activeHabits = appState.habits.filter(h => h.active !== false).slice(0, 5);

      if (activeHabits.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Nenhuma rotina cadastrada</p></div>';
        return;
      }

      const currentDate = agendaHandlers.state.date || utils.getTodayISO();
      container.innerHTML = activeHabits.map(habit => {
        const log = appState.habitLogs.find(l => l.habitId === habit.id && l.date === currentDate);
        const completed = log?.completed || false;

        return `
          <div class="flex-between" style="padding: 12px; border-bottom: 1px solid var(--border-color);">
            <div>
              <strong>${utils.sanitize(habit.name)}</strong>
              <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">${utils.sanitize(habit.description || '')}</p>
            </div>
            <button class="btn btn-sm ${completed ? 'btn-success' : 'btn-secondary'}"
                    onclick="habitHandlers.toggleToday('${habit.id}')">
              <span class="material-icons">${completed ? 'check_circle' : 'radio_button_unchecked'}</span>
            </button>
          </div>
        `;
      }).join('');
    },

    renderDashboardTasks: function() {
      const container = document.getElementById('dashboard-tasks-list');
      const activeTasks = appState.tasks.filter(t => t.status !== 'done').slice(0, 5);

      if (activeTasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Nenhuma tarefa ativa</p></div>';
        return;
      }

      container.innerHTML = activeTasks.map(task => `
        <div class="flex-between" style="padding: 12px; border-bottom: 1px solid var(--border-color);">
          <div>
            <strong>${utils.sanitize(task.title)}</strong>
            <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">
              ${task.status === 'todo' ? 'A fazer' : task.status === 'doing' ? 'Em andamento' : 'Concluido'}
            </p>
          </div>
          <a href="#tasks" class="btn btn-sm btn-secondary">Ver</a>
        </div>
      `).join('');
    },

    getAgendaItems: function(dateStr) {
      const items = [];
      const habits = appState.habits.filter(h => h.active !== false);
      habits.forEach(habit => {
        const occursToday = habit.nextOccurrence ? habit.nextOccurrence === dateStr : true;
        if (!occursToday) return;
        items.push({
          time: habit.scheduledTime || '',
          title: habit.name,
          type: 'habit',
          meta: habit.timeWindow || 'Rotina',
          status: 'pending',
          id: habit.id
        });
      });

      const tasks = appState.tasks.filter(t => t.dueDate === dateStr);
      tasks.forEach(task => {
        items.push({
          time: task.dueTime || '',
          title: task.title,
          type: 'task',
          meta: task.status || 'open',
          status: task.status,
          id: task.id
        });
      });

      const goals = appState.goals.filter(g => g.dueDate === dateStr);
      goals.forEach(goal => {
        items.push({
          time: goal.dueTime || '',
          title: goal.title,
          type: 'goal',
          meta: 'Meta',
          status: goal.status,
          id: goal.id
        });
      });

      items.sort((a, b) => {
        if (!a.time && b.time) return 1;
        if (a.time && !b.time) return -1;
        return a.time.localeCompare(b.time);
      });

      return items;
    },

    renderAgenda: function(container) {
      const currentDate = agendaHandlers.state.date || utils.getTodayISO();
      const items = this.getAgendaItems(currentDate);
      const rows = items.length === 0
        ? `<div class="empty-state"><p>Nenhum item agendado para hoje.</p></div>`
        : `<div class="timeline">${items.map(item => `
          <div class="timeline-row">
            <div class="timeline-time">${item.time ? utils.formatTime(item.time) : 'Livre'}</div>
            <div class="timeline-card">
              <div>
                <strong>${utils.sanitize(item.title)}</strong>
                <div style="font-size: 12px; color: var(--text-secondary);">${utils.sanitize(item.meta)}</div>
              </div>
              <span class="badge">${item.type}</span>
            </div>
          </div>
        `).join('')}</div>`;

      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>Agenda</h1>
              <span>Visao do dia com rotinas, tarefas e metas.</span>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-secondary" onclick="agendaHandlers.previousDay()">Voltar</button>
              <button class="btn btn-primary" onclick="agendaHandlers.today()">Hoje</button>
              <button class="btn btn-secondary" onclick="agendaHandlers.nextDay()">Avancar</button>
            </div>
          </div>

          <div class="agenda-grid">
            <div class="agenda-day">
              <div class="agenda-header">
                <h3>${utils.formatRelativeDate(currentDate)}</h3>
                <span class="chip">America/Sao_Paulo</span>
              </div>
              ${rows}
            </div>
          </div>
        </div>
      `;
    },

    renderFocus: function(container) {
      const activeTask = appState.tasks.find(t => t.id === appState.focus.taskId) || null;
      const label = activeTask ? activeTask.title : 'Escolha uma tarefa';
      const minutes = Math.floor(appState.focus.remainingSeconds / 60).toString().padStart(2, '0');
      const seconds = (appState.focus.remainingSeconds % 60).toString().padStart(2, '0');

      const totalSeconds = 1500;
      const progress = ((totalSeconds - appState.focus.remainingSeconds) / totalSeconds) * 100;
      const circumference = 2 * Math.PI * 120;
      const offset = circumference - (progress / 100) * circumference;

      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>Modo Foco</h1>
              <span>TÃ©cnica Pomodoro - 25 minutos de foco total</span>
            </div>
          </div>

          <div class="focus-container">
            <div class="focus-card">
              <div class="focus-task-info">
                <span class="material-icons" style="font-size: 20px; color: var(--accent-blue);">
                  ${activeTask ? 'task_alt' : 'radio_button_unchecked'}
                </span>
                <div style="flex: 1;">
                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">Tarefa Atual</div>
                  <div style="font-weight: 600; color: var(--text-primary);">${utils.sanitize(label)}</div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="focusHandlers.pickTask()">
                  <span class="material-icons">edit</span>
                </button>
              </div>

              <div class="focus-timer-container">
                <svg class="focus-circle" viewBox="0 0 260 260">
                  <circle class="focus-circle-bg" cx="130" cy="130" r="120"></circle>
                  <circle
                    class="focus-circle-progress ${appState.focus.isRunning ? 'running' : ''}"
                    cx="130"
                    cy="130"
                    r="120"
                    style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"
                  ></circle>
                </svg>
                <div class="focus-timer-content">
                  <div class="focus-timer-display">${minutes}:${seconds}</div>
                  <div class="focus-timer-label">${appState.focus.isRunning ? 'Em andamento' : 'Pausado'}</div>
                </div>
              </div>

              <div class="focus-controls">
                <button class="btn btn-secondary" onclick="focusHandlers.reset()">
                  <span class="material-icons">refresh</span>
                  Resetar
                </button>
                <button class="btn ${appState.focus.isRunning ? 'btn-danger' : 'btn-primary'} btn-lg" onclick="focusHandlers.toggle()" ${!activeTask ? 'disabled' : ''}>
                  <span class="material-icons">${appState.focus.isRunning ? 'pause' : 'play_arrow'}</span>
                  ${appState.focus.isRunning ? 'Pausar' : 'Iniciar'}
                </button>
                <button class="btn btn-secondary" onclick="focusHandlers.skip()">
                  <span class="material-icons">skip_next</span>
                  Pular
                </button>
              </div>

              <div class="focus-stats">
                <div class="focus-stat">
                  <span class="material-icons" style="color: var(--accent-green);">timer</span>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">
                      ${Math.floor(progress)}%
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Progresso</div>
                  </div>
                </div>
                <div class="focus-stat">
                  <span class="material-icons" style="color: var(--accent-blue);">flag</span>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">
                      ${Math.floor((1500 - appState.focus.remainingSeconds) / 60)}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Minutos</div>
                  </div>
                </div>
                <div class="focus-stat">
                  <span class="material-icons" style="color: var(--accent-orange);">schedule</span>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">
                      ${Math.floor(appState.focus.remainingSeconds / 60)}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Restantes</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="focus-tips">
              <h3 style="margin-bottom: 12px; color: var(--text-primary);">
                <span class="material-icons" style="vertical-align: middle;">lightbulb</span>
                Dicas para Foco Total
              </h3>
              <ul style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 8px;">
                <li style="display: flex; gap: 8px; color: var(--text-secondary);">
                  <span class="material-icons" style="font-size: 18px; color: var(--accent-blue);">check_circle</span>
                  Elimine todas as distraÃ§Ãµes
                </li>
                <li style="display: flex; gap: 8px; color: var(--text-secondary);">
                  <span class="material-icons" style="font-size: 18px; color: var(--accent-blue);">check_circle</span>
                  Silencie notificaÃ§Ãµes do celular
                </li>
                <li style="display: flex; gap: 8px; color: var(--text-secondary);">
                  <span class="material-icons" style="font-size: 18px; color: var(--accent-blue);">check_circle</span>
                  Foque em uma tarefa por vez
                </li>
                <li style="display: flex; gap: 8px; color: var(--text-secondary);">
                  <span class="material-icons" style="font-size: 18px; color: var(--accent-blue);">check_circle</span>
                  FaÃ§a uma pausa apÃ³s o ciclo
                </li>
              </ul>
            </div>
          </div>
        </div>
      `;
    },

    renderHeatmap: function() {
      // Usar cache para evitar recalcular o heatmap
      if (perfCache.heatmapData) {
        return perfCache.heatmapData;
      }

      const days = 90;
      const today = new Date();

      // Otimizar: criar um Map de logs por data
      const logsByDate = new Map();
      appState.habitLogs.forEach(log => {
        if (log.completed) {
          const count = logsByDate.get(log.date) || 0;
          logsByDate.set(log.date, count + 1);
        }
      });

      const cells = [];
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const iso = date.toISOString().split('T')[0];
        const count = logsByDate.get(iso) || 0;
        const level = count >= 4 ? 4 : count >= 3 ? 3 : count >= 2 ? 2 : count >= 1 ? 1 : 0;
        cells.push(`<div class="heatmap-cell" data-level="${level}" title="${iso}: ${count} rotinas"></div>`);
      }

      const html = `<div class="heatmap">${cells.join('')}</div>`;
      perfCache.heatmapData = html;
      return html;
    },

    renderHabits: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <h1>Rotinas</h1>
            <button class="btn btn-primary" onclick="habitHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Rotina
            </button>
          </div>

          <div id="habits-list"></div>
        </div>
      `;

      this.renderHabitsList();
    },

    renderHabitsList: function() {
      const container = document.getElementById('habits-list');
      const habits = appState.habits.filter(h => h.active !== false);

      if (habits.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">check_circle</span>
            <h3 class="empty-state-title">Nenhuma rotina cadastrada</h3>
            <p class="empty-state-description">Crie sua primeira rotina para comeÃ§ar!</p>
          </div>
        `;
        return;
      }

      const currentDate = agendaHandlers.state.date || utils.getTodayISO();
      container.innerHTML = `<div class="grid">${habits.map(habit => {
        const log = appState.habitLogs.find(l => l.habitId === habit.id && l.date === currentDate);
        const completed = log?.completed || false;
        const streak = perfCache.getStreak(habit.id, appState.habitLogs);
        const scheduleLabel = [habit.scheduledTime, habit.timeWindow].filter(Boolean).join(' ï¿½ ');

        return `
          <div class="card ${completed ? 'glow-green' : ''}">
            <div class="flex-between mb-md">
              <h3>${utils.sanitize(habit.name)}</h3>
              <div class="flex gap-sm">
                <button class="btn btn-sm btn-secondary" onclick="habitHandlers.openEditModal('${habit.id}')" title="Editar">
                  <span class="material-icons">edit</span>
                </button>
                <button class="btn btn-sm ${completed ? 'btn-success' : 'btn-secondary'}"
                        onclick="habitHandlers.toggleToday('${habit.id}')" title="${completed ? 'Desmarcar' : 'Concluir'}">
                  <span class="material-icons">${completed ? 'check_circle' : 'radio_button_unchecked'}</span>
                </button>
              </div>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">${utils.sanitize(habit.description || '')}</p>
            <div class="flex gap-md">
              <div style="flex: 1;">
                <small style="color: var(--text-tertiary);">Sequencia atual</small>
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">${streak.current} dias</div>
              </div>
              <div style="flex: 1;">
                <small style="color: var(--text-tertiary);">Melhor sequencia</small>
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-purple);">${streak.max} dias</div>
              </div>
            </div>
          </div>
        `;
      }).join('')}</div>`;
    },

    renderTasks: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <h1>Tarefas</h1>
            <button class="btn btn-primary" onclick="taskHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Tarefa
            </button>
          </div>

          <div id="tasks-list"></div>
        </div>
      `;

      this.renderTasksList();
    },

    renderTasksList: function() {
      const container = document.getElementById('tasks-list');
      const tasks = appState.tasks;

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">task_alt</span>
            <h3 class="empty-state-title">Nenhuma tarefa cadastrada</h3>
            <p class="empty-state-description">Crie sua primeira tarefa!</p>
          </div>
        `;
        return;
      }

      const todoTasks = tasks.filter(t => t.status === 'todo');
      const doingTasks = tasks.filter(t => t.status === 'doing');
      const doneTasks = tasks.filter(t => t.status === 'done');

      container.innerHTML = `
        <div class="grid grid-3">
          <div>
            <h3 style="margin-bottom: 16px;">ðŸ“‹ A Fazer (${todoTasks.length})</h3>
            <div class="grid gap-sm">
              ${todoTasks.map(t => this.renderTaskCard(t)).join('')}
            </div>
          </div>
          <div>
            <h3 style="margin-bottom: 16px;">âš¡ Em Andamento (${doingTasks.length})</h3>
            <div class="grid gap-sm">
              ${doingTasks.map(t => this.renderTaskCard(t)).join('')}
            </div>
          </div>
          <div>
            <h3 style="margin-bottom: 16px;">âœ… ConcluÃ­do (${doneTasks.length})</h3>
            <div class="grid gap-sm">
              ${doneTasks.map(t => this.renderTaskCard(t)).join('')}
            </div>
          </div>
        </div>
      `;
    },

    renderTaskCard: function(task) {
      const priorityColors = {
        urgent: 'badge-urgent',
        high: 'badge-high',
        normal: 'badge-normal',
        low: 'badge-low'
      };
      const dueLabel = task.dueDate
        ? `${utils.formatRelativeDate(task.dueDate)}${task.dueTime ? ' ' + utils.formatTime(task.dueTime) : ''}`
        : 'Sem data';

      return `
        <div class="card">
          <div class="flex-between mb-sm">
            <strong>${utils.sanitize(task.title)}</strong>
            <span class="badge ${priorityColors[task.priority] || 'badge-normal'}">${task.priority || 'normal'}</span>
          </div>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
            ${utils.sanitize(task.description || '')}
          </p>
          <div class="flex gap-sm" style="margin-bottom: 12px;">
            <span class="chip">${utils.sanitize(dueLabel)}</span>
          </div>
          <div class="flex gap-sm">
            ${task.status !== 'done' ? `
              <button class="btn btn-sm btn-success" onclick="taskHandlers.setStatus('${task.id}', 'done')" style="flex: 1;">
                Concluir
              </button>
            ` : ''}
            <button class="btn btn-sm btn-secondary" onclick="taskHandlers.openEditModal('${task.id}')" style="flex: 1;">
              Editar
            </button>
          </div>
        </div>
      `;
    },

    renderKanban: function(container) {
      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>Kanban</h1>
              <span>Arraste e solte para organizar suas tarefas</span>
            </div>
            <button class="btn btn-primary" onclick="taskHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Tarefa
            </button>
          </div>
          <div id="kanban-board"></div>
        </div>
      `;

      this.renderKanbanBoard();
    },

    renderKanbanBoard: function() {
      const container = document.getElementById('kanban-board');
      const tasks = appState.tasks;

      const columns = [
        { id: 'todo', title: 'ðŸ“‹ A Fazer', color: 'var(--accent-blue)', tasks: tasks.filter(t => t.status === 'todo') },
        { id: 'doing', title: 'âš¡ Em Andamento', color: 'var(--accent-orange)', tasks: tasks.filter(t => t.status === 'doing') },
        { id: 'done', title: 'âœ… ConcluÃ­do', color: 'var(--accent-green)', tasks: tasks.filter(t => t.status === 'done') }
      ];

      container.innerHTML = `
        <div class="kanban-board">
          ${columns.map(col => `
            <div class="kanban-column" data-status="${col.id}">
              <div class="kanban-header" style="border-left: 4px solid ${col.color};">
                <span>${col.title}</span>
                <span class="kanban-count">${col.tasks.length}</span>
              </div>
              <div class="kanban-cards" data-column="${col.id}">
                ${col.tasks.length === 0 ? '<div class="kanban-empty">Arraste tarefas aqui</div>' : ''}
                ${col.tasks.map(task => {
                  const priorityColors = { high: 'var(--accent-red)', medium: 'var(--accent-orange)', low: 'var(--accent-blue)' };
                  return `
                    <div class="kanban-card" draggable="true" data-task-id="${task.id}">
                      <div class="kanban-card-header">
                        <div class="kanban-card-title">${utils.sanitize(task.title)}</div>
                        <span class="kanban-card-menu" onclick="taskHandlers.openEditModal('${task.id}')">
                          <span class="material-icons" style="font-size: 18px;">more_vert</span>
                        </span>
                      </div>
                      ${task.description ? `
                        <p class="kanban-card-description">${utils.sanitize(task.description)}</p>
                      ` : ''}
                      <div class="kanban-card-footer">
                        ${task.priority ? `
                          <span class="kanban-card-priority" style="background: ${priorityColors[task.priority]}20; color: ${priorityColors[task.priority]};">
                            ${task.priority}
                          </span>
                        ` : ''}
                        ${task.dueDate ? `
                          <span class="kanban-card-due">
                            <span class="material-icons" style="font-size: 14px;">event</span>
                            ${utils.formatRelativeDate(task.dueDate)}
                          </span>
                        ` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Ativar drag and drop
      this.initKanbanDragDrop();
    },

    initKanbanDragDrop: function() {
      const cards = document.querySelectorAll('.kanban-card[draggable="true"]');
      const columns = document.querySelectorAll('.kanban-cards');

      let draggedElement = null;

      cards.forEach(card => {
        card.addEventListener('dragstart', (e) => {
          draggedElement = card;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', card.innerHTML);
        });

        card.addEventListener('dragend', (e) => {
          card.classList.remove('dragging');
          draggedElement = null;
        });
      });

      columns.forEach(column => {
        column.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          column.classList.add('drag-over');
        });

        column.addEventListener('dragleave', (e) => {
          column.classList.remove('drag-over');
        });

        column.addEventListener('drop', async (e) => {
          e.preventDefault();
          column.classList.remove('drag-over');

          if (!draggedElement) return;

          const taskId = draggedElement.getAttribute('data-task-id');
          const newStatus = column.getAttribute('data-column');
          const currentCard = draggedElement;

          // Optimistic update - mover visualmente primeiro
          column.appendChild(draggedElement);

          // Remover mensagem "Arraste tarefas aqui" se existir
          const emptyMsg = column.querySelector('.kanban-empty');
          if (emptyMsg) emptyMsg.remove();

          // Atualizar no backend
          const result = await api.setTaskStatus(taskId, newStatus);

          if (result.ok) {
            applyFullState(result.data);
          notifications.refreshBadge();
            toast.success('Tarefa movida!');

            // Re-renderizar para atualizar contadores
            setTimeout(() => this.renderKanbanBoard(), 500);
          } else {
            toast.error('Erro ao mover tarefa');
            // Reverter o movimento visual se falhar
            this.renderKanbanBoard();
          }
        });
      });
    },

    renderCalendar: function(container) {
      // Estado do calendÃ¡rio
      if (!this.calendarState) {
        const today = new Date();
        this.calendarState = {
          year: today.getFullYear(),
          month: today.getMonth()
        };
      }

      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>CalendÃ¡rio</h1>
              <span>Visualize suas rotinas e tarefas</span>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-secondary" onclick="views.calendarPrevMonth()">
                <span class="material-icons">chevron_left</span>
              </button>
              <button class="btn btn-primary" onclick="views.calendarToday()">Hoje</button>
              <button class="btn btn-secondary" onclick="views.calendarNextMonth()">
                <span class="material-icons">chevron_right</span>
              </button>
            </div>
          </div>

          <div class="card">
            <div id="calendar-view"></div>
          </div>
        </div>
      `;

      this.renderCalendarView();
    },

    calendarPrevMonth: function() {
      this.calendarState.month--;
      if (this.calendarState.month < 0) {
        this.calendarState.month = 11;
        this.calendarState.year--;
      }
      this.renderCalendarView();
    },

    calendarNextMonth: function() {
      this.calendarState.month++;
      if (this.calendarState.month > 11) {
        this.calendarState.month = 0;
        this.calendarState.year++;
      }
      this.renderCalendarView();
    },

    calendarToday: function() {
      const today = new Date();
      this.calendarState.year = today.getFullYear();
      this.calendarState.month = today.getMonth();
      this.renderCalendarView();
    },

    renderCalendarView: function() {
      const container = document.getElementById('calendar-view');
      if (!container) return;

      const { year, month } = this.calendarState;
      const monthNames = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      // Criar grid de dias
      let calendarHTML = `
        <div style="margin-bottom: 24px;">
          <h2 style="text-align: center; color: var(--text-primary); margin: 0;">
            ${monthNames[month]} ${year}
          </h2>
        </div>
        <div class="calendar-grid">
          ${dayNames.map(day => `
            <div class="calendar-day-name">${day}</div>
          `).join('')}
      `;

      // CÃ©lulas vazias antes do primeiro dia
      for (let i = 0; i < startingDayOfWeek; i++) {
        calendarHTML += '<div class="calendar-day empty"></div>';
      }

      // Dias do mÃªs
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = dateStr === todayStr;

        // Buscar tarefas e rotinas deste dia
        const dayTasks = appState.tasks.filter(t => t.dueDate === dateStr);
        const dayHabits = appState.habits.filter(h => {
          if (h.active === false) return false;
          if (h.nextOccurrence) return h.nextOccurrence === dateStr;
          return true;
        });

        const totalItems = dayTasks.length + dayHabits.length;

        calendarHTML += `
          <div class="calendar-day ${isToday ? 'today' : ''}" onclick="calendarHandlers.openDay('${dateStr}')">
            <div class="calendar-day-number">${day}</div>
            ${totalItems > 0 ? `
              <div class="calendar-day-dots">
                ${dayTasks.length > 0 ? `<span class="calendar-dot task" title="${dayTasks.length} tarefa(s)"></span>` : ''}
                ${dayHabits.length > 0 ? `<span class="calendar-dot habit" title="${dayHabits.length} rotina(s)"></span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }

      calendarHTML += '</div>';
      container.innerHTML = calendarHTML;
    },

    renderGoals: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <h1>Metas</h1>
            <button class="btn btn-primary" onclick="goalHandlers.openCreateModal()">
              <span class="material-icons">add</span>
              Nova Meta
            </button>
          </div>

          <div id="goals-list"></div>
        </div>
      `;

      this.renderGoalsList();
    },

    renderGoalsList: function() {
      const container = document.getElementById('goals-list');
      const goals = appState.goals;

      if (goals.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">flag</span>
            <h3 class="empty-state-title">Nenhuma meta cadastrada</h3>
            <p class="empty-state-description">Defina suas primeiras metas!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `<div class="grid">${goals.map(goal => {
        const progress = goal.targetValue > 0 ? ((goal.currentValue || 0) / goal.targetValue) * 100 : 0;
        const isComplete = progress >= 100;

        return `
          <div class="card ${isComplete ? 'glow-green' : 'glow-blue'}">
            <div class="flex-between mb-md">
              <h3>${utils.sanitize(goal.name)}</h3>
              <div class="flex gap-sm" style="align-items: center;">
                ${isComplete ? '<span class="badge badge-low">âœ… ConcluÃ­da</span>' : ''}
                <button class="btn btn-sm btn-secondary" onclick="goalHandlers.openEditModal('${goal.id}')" title="Editar">
                  <span class="material-icons">edit</span>
                </button>
              </div>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">${utils.sanitize(goal.description || '')}</p>

            <div class="flex-between mb-sm">
              <span style="font-size: 24px; font-weight: 700;">${goal.currentValue || 0} / ${goal.targetValue} ${goal.unit ? utils.sanitize(goal.unit) : ''}</span>
              <span style="font-size: 18px; font-weight: 600; color: var(--accent-blue);">${Math.round(progress)}%</span>
            </div>

            <div class="progress-bar">
              <div class="progress-fill ${isComplete ? 'success' : ''}" style="width: ${Math.min(progress, 100)}%"></div>
            </div>

            ${goal.deadline ? `
              <p style="font-size: 13px; color: var(--text-tertiary); margin-top: 12px;">
                ðŸ“… Prazo: ${utils.formatDate(goal.deadline)}
              </p>
            ` : ''}
          </div>
        `;
      }).join('')}</div>`;
    },

    renderReports: function(container) {
      const today = utils.getTodayISO();
      const tasks = appState.tasks;
      const habits = appState.habits.filter(h => h.active !== false);
      const goals = appState.goals;
      const focusLogs = Array.isArray(appState.focusLogs) ? appState.focusLogs : [];

      const statusBuckets = { todo: 0, doing: 0, done: 0, other: 0 };
      tasks.forEach(task => {
        if (task.status === 'done') statusBuckets.done++;
        else if (task.status === 'doing') statusBuckets.doing++;
        else if (task.status === 'todo' || task.status === 'open') statusBuckets.todo++;
        else statusBuckets.other++;
      });

      const activeTasks = tasks.filter(t => t.status !== 'done');
      const overdueTasks = activeTasks.filter(t => t.dueDate && t.dueDate < today);

      const totalHabits = habits.length;
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        last7Days.push(d.toISOString().split('T')[0]);
      }

      const habitSeries = last7Days.map(dateStr => {
        const completed = appState.habitLogs.filter(l => l.date === dateStr && l.completed).length;
        const rate = totalHabits ? Math.round((completed / totalHabits) * 100) : 0;
        return { date: dateStr, completed: completed, rate: rate };
      });

      const averageHabitRate = habitSeries.length
        ? Math.round(habitSeries.reduce((sum, d) => sum + d.rate, 0) / habitSeries.length)
        : 0;

      const goalsCompleted = goals.filter(g => g.status === 'completed').length;
      const goalsTotal = goals.length;
      const goalProgress = goalsTotal
        ? Math.round(goals.reduce((sum, g) => sum + ((g.currentValue || 0) / Math.max(1, g.targetValue || 1)) * 100, 0) / goalsTotal)
        : 0;

      const focusCutoff = new Date(today);
      focusCutoff.setDate(focusCutoff.getDate() - 6);
      const recentFocus = focusLogs.filter(l => new Date(l.startedAt || l.createdAt || today) >= focusCutoff);
      const focusMinutes = recentFocus.reduce((sum, l) => sum + (parseInt(l.durationMinutes, 10) || 0), 0);

      const totalTasks = tasks.length;
      const taskDoneRate = totalTasks ? Math.round((statusBuckets.done / totalTasks) * 100) : 0;

      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>Relatorios</h1>
              <span>Visao geral de desempenho e produtividade.</span>
            </div>
          </div>

          <div class="report-grid">
            <div class="report-card">
              <div class="report-label">Tarefas ativas</div>
              <div class="report-value">${activeTasks.length}</div>
              <div class="report-sub">${overdueTasks.length} atrasadas</div>
            </div>
            <div class="report-card">
              <div class="report-label">Conclusao semanal</div>
              <div class="report-value">${averageHabitRate}%</div>
              <div class="report-sub">${totalHabits} rotinas ativas</div>
            </div>
            <div class="report-card">
              <div class="report-label">Progresso de metas</div>
              <div class="report-value">${goalProgress}%</div>
              <div class="report-sub">${goalsCompleted}/${goalsTotal} concluidas</div>
            </div>
            <div class="report-card">
              <div class="report-label">Foco (7 dias)</div>
              <div class="report-value">${focusMinutes} min</div>
              <div class="report-sub">${recentFocus.length} sessoes</div>
            </div>
          </div>

          <div class="card mt-lg">
            <div class="card-header">
              <h2 class="card-title">Distribuicao de tarefas</h2>
              <span class="chip">${taskDoneRate}% concluidas</span>
            </div>
            <div class="report-bars">
              <div class="report-bar">
                <div class="report-bar-label">A fazer</div>
                <div class="report-bar-track">
                  <div class="report-bar-fill" style="width: ${totalTasks ? Math.round((statusBuckets.todo / totalTasks) * 100) : 0}%"></div>
                </div>
                <div class="report-bar-value">${statusBuckets.todo}</div>
              </div>
              <div class="report-bar">
                <div class="report-bar-label">Em andamento</div>
                <div class="report-bar-track">
                  <div class="report-bar-fill report-bar-warn" style="width: ${totalTasks ? Math.round((statusBuckets.doing / totalTasks) * 100) : 0}%"></div>
                </div>
                <div class="report-bar-value">${statusBuckets.doing}</div>
              </div>
              <div class="report-bar">
                <div class="report-bar-label">Concluidas</div>
                <div class="report-bar-track">
                  <div class="report-bar-fill report-bar-success" style="width: ${totalTasks ? Math.round((statusBuckets.done / totalTasks) * 100) : 0}%"></div>
                </div>
                <div class="report-bar-value">${statusBuckets.done}</div>
              </div>
              ${statusBuckets.other ? `
                <div class="report-bar">
                  <div class="report-bar-label">Outras</div>
                  <div class="report-bar-track">
                    <div class="report-bar-fill report-bar-muted" style="width: ${totalTasks ? Math.round((statusBuckets.other / totalTasks) * 100) : 0}%"></div>
                  </div>
                  <div class="report-bar-value">${statusBuckets.other}</div>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="card mt-md">
            <div class="card-header">
              <h2 class="card-title">Conclusao de rotinas (7 dias)</h2>
              <span class="chip">${averageHabitRate}% media</span>
            </div>
            <div class="report-sparkline">
              ${habitSeries.map(day => `
                <div class="spark-column">
                  <div class="spark-bar" style="height: ${Math.max(6, day.rate)}%"></div>
                  <div class="spark-label">${day.rate}%</div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="card mt-md">
            <div class="card-header">
              <h2 class="card-title">Metas em andamento</h2>
              <a href="#goals" class="btn btn-sm btn-secondary">Ver metas</a>
            </div>
            ${goals.length === 0 ? `
              <div class="empty-state">
                <span class="material-icons empty-state-icon">flag</span>
                <h3 class="empty-state-title">Nenhuma meta cadastrada</h3>
                <p class="empty-state-description">Defina suas metas para acompanhar progresso.</p>
              </div>
            ` : `
              <div class="report-goals">
                ${goals.slice(0, 5).map(goal => {
                  const progress = goal.targetValue ? Math.min(100, Math.round((goal.currentValue / goal.targetValue) * 100)) : 0;
                  return `
                    <div class="report-goal">
                      <div>
                        <strong>${utils.sanitize(goal.title || goal.name || '')}</strong>
                        <div class="report-goal-meta">${goal.currentValue || 0}/${goal.targetValue || 0} ${utils.sanitize(goal.unit || '')}</div>
                      </div>
                      <div class="report-goal-progress">
                        <div class="report-goal-track">
                          <div class="report-goal-fill" style="width: ${progress}%"></div>
                        </div>
                        <span>${progress}%</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    },

    renderNotifications: function(container) {
      container.innerHTML = `
        <div>
          <div class="page-header">
            <div class="page-title">
              <h1>Notificacoes</h1>
              <span>Acompanhe alertas e pendencias importantes.</span>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-secondary" onclick="notificationHandlers.markAllRead()">
                <span class="material-icons">done_all</span>
                Marcar tudo como lido
              </button>
            </div>
          </div>

          <div id="notifications-summary" class="mb-md" style="color: var(--text-secondary); font-size: 14px;"></div>
          <div id="notifications-list"></div>
        </div>
      `;

      notificationHandlers.load();
    },
    renderClickUp: function(container) {
      container.innerHTML = `
        <div>
          <div class="flex-between mb-lg">
            <div>
              <h1>ClickUp</h1>
              <p style="color: var(--text-secondary); margin-top: 6px;">Visualize e gerencie tarefas sincronizadas do ClickUp</p>
            </div>
            <button class="btn btn-primary" onclick="clickupPageHandlers.syncNow()" id="clickup-page-sync-btn">
              <span class="material-icons">sync</span>
              Sincronizar agora
            </button>
          </div>

          <div class="card mb-lg">
            <div class="card-header">
              <h2 class="card-title">Status da sincronizacao</h2>
              <button class="btn btn-sm btn-secondary" onclick="clickupPageHandlers.loadStatus()">
                <span class="material-icons">refresh</span>
                Atualizar
              </button>
            </div>
            <div id="clickup-page-status"></div>
          </div>

          <div class="card">
            <div class="filter-grid mb-md">
              <div>
                <label class="form-label">Busca</label>
                <input type="text" class="form-input" id="clickup-search" placeholder="Buscar por titulo, responsavel, status, prioridade">
              </div>
              <div>
                <label class="form-label">Responsavel</label>
                <input type="text" class="form-input" id="clickup-filter-assignee" placeholder="Nome ou email">
              </div>
              <div>
                <label class="form-label">Prioridade</label>
                <select class="form-select" id="clickup-filter-priority">
                  <option value="all">Todas</option>
                  <option value="urgent">Urgente</option>
                  <option value="high">Alta</option>
                  <option value="normal">Normal</option>
                  <option value="low">Baixa</option>
                </select>
              </div>
              <div>
                <label class="form-label">Ordenar</label>
                <select class="form-select" id="clickup-sort">
                  <option value="updated:desc">Atualizado (desc)</option>
                  <option value="updated:asc">Atualizado (asc)</option>
                  <option value="due:asc">Due date (asc)</option>
                  <option value="due:desc">Due date (desc)</option>
                  <option value="priority:desc">Prioridade (alta)</option>
                  <option value="priority:asc">Prioridade (baixa)</option>
                </select>
              </div>
            </div>

            <div class="filter-row mb-sm">
              <div class="flex gap-sm flex-wrap">
                <button class="btn btn-sm btn-secondary clickup-filter" data-status="all">Todos</button>
                <button class="btn btn-sm btn-secondary clickup-filter" data-status="open">Open</button>
                <button class="btn btn-sm btn-secondary clickup-filter" data-status="doing">Doing</button>
                <button class="btn btn-sm btn-secondary clickup-filter" data-status="done">Done</button>
              </div>
              <div class="flex gap-sm flex-wrap">
                <button class="btn btn-sm btn-secondary" id="clickup-toggle-only-mine" data-active="true">Minhas</button>
                <button class="btn btn-sm btn-secondary" id="clickup-toggle-unassigned" data-active="false">Sem responsavel</button>
                <button class="btn btn-sm btn-secondary" id="clickup-toggle-out-of-view" data-active="false">Fora da view</button>
                <button class="btn btn-sm btn-secondary" id="clickup-clear-filters">Limpar filtros</button>
              </div>
            </div>

            <div class="filter-row mb-md">
              <div class="filter-date">
                <label class="form-label">Due date</label>
                <div class="filter-date-range">
                  <input type="date" class="form-input" id="clickup-filter-due-start">
                  <span>ate</span>
                  <input type="date" class="form-input" id="clickup-filter-due-end">
                </div>
              </div>
              <div class="filter-date">
                <label class="form-label">Atualizado</label>
                <div class="filter-date-range">
                  <input type="date" class="form-input" id="clickup-filter-updated-start">
                  <span>ate</span>
                  <input type="date" class="form-input" id="clickup-filter-updated-end">
                </div>
              </div>
            </div>

            <div class="flex-between mb-md">
              <div id="clickup-results-summary" style="color: var(--text-secondary); font-size: 14px;"></div>
              <div id="clickup-loading-indicator" style="color: var(--text-tertiary); font-size: 13px;"></div>
            </div>

            <div id="clickup-tasks-list"></div>

            <div class="flex-center mt-md" id="clickup-load-more-wrap" style="display: none;">
              <button class="btn btn-secondary" onclick="clickupPageHandlers.loadMore()" id="clickup-load-more-btn">
                Carregar mais
              </button>
            </div>
          </div>
        </div>
      `;

      clickupPageHandlers.init();
    },

    renderSettings: function(container) {
      container.innerHTML = `
        <div>
          <h1>ConfiguraÃ§Ãµes</h1>

          <div class="card">
            <h3 class="mb-md">AparÃªncia</h3>
            <div class="form-group">
              <label class="form-label">Tema</label>
              <select class="form-select" id="theme-select">
                <option value="light" ${appState.preferences.theme === 'light' ? 'selected' : ''}>Claro</option>
                <option value="dark" ${appState.preferences.theme === 'dark' ? 'selected' : ''}>Escuro</option>
              </select>
            </div>
          </div>

          <div class="card mt-md">
            <h3 class="mb-md">Conta</h3>
            <div class="flex-between">
              <div>
                <p style="color: var(--text-secondary); margin-bottom: 4px;">UsuÃ¡rio conectado</p>
                <strong id="settings-user-email">${appState.userKey || 'Carregando...'}</strong>
              </div>
              <button class="btn btn-danger" onclick="authHandlers.logout()">Sair</button>
            </div>
          </div>

          <div class="card mt-md">
            <h3 class="mb-md">Dados</h3>
            <button class="btn btn-secondary w-full" onclick="settingsHandlers.exportData()">
              <span class="material-icons">download</span>
              Exportar Dados
            </button>
          </div>

          <div class="card mt-md">
            <h3 class="mb-md">IntegraÃ§Ã£o ClickUp</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
              Sincronize automaticamente tarefas da sua VIEW do ClickUp
            </p>

            <div id="clickup-status" class="mb-md"></div>

            <div class="flex gap-sm">
              <button class="btn btn-primary" onclick="clickupHandlers.syncNow()" id="clickup-sync-btn" style="flex: 1;">
                <span class="material-icons">sync</span>
                Sincronizar Agora
              </button>
              <button class="btn btn-secondary" onclick="clickupHandlers.checkStatus()">
                <span class="material-icons">info</span>
                Status
              </button>
            </div>
          </div>
        </div>
      `;

      const themeSelect = document.getElementById('theme-select');
      if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
          theme.apply(e.target.value);
          storage.save('theme', e.target.value);
        });
      }

      // Carregar status do ClickUp automaticamente
      clickupHandlers.checkStatus();
    }
  };

  // ============================================
  // HANDLERS
  // ============================================

  const habitHandlers = {
    toggleToday: async function(habitId) {
      const today = utils.getTodayISO();

      // Optimistic update
      const log = appState.habitLogs.find(l => l.habitId === habitId && l.date === today);
      const previousCompleted = log?.completed || false;

      // Atualizar UI imediatamente
      if (log) {
        log.completed = !log.completed;
      } else {
        appState.habitLogs.push({
          habitId: habitId,
          date: today,
          completed: true,
          createdAt: new Date().toISOString()
        });
      }
      refreshUI();

      // Fazer chamada ao backend
      const result = await api.toggleHabitCompletion(habitId, today);

      if (result.ok) {
        applyFullState(result.data);
        refreshUI();
      } else {
        // Reverter se falhar
        if (log) {
          log.completed = previousCompleted;
        } else {
          const index = appState.habitLogs.findIndex(l => l.habitId === habitId && l.date === today);
          if (index > -1) appState.habitLogs.splice(index, 1);
        }
        refreshUI();
        toast.error('Erro ao atualizar rotina: ' + result.error);
      }
    },

    openCreateModal: function() {
      const content = `
        <form id="create-habit-form">
          <div class="form-group">
            <label class="form-label">Nome da Rotina *</label>
            <input type="text" class="form-input" id="habit-name" placeholder="Ex: ExercÃ­cio matinal" required>
          </div>

          <div class="form-group">
            <label class="form-label">DescriÃ§Ã£o</label>
            <textarea class="form-textarea" id="habit-description" placeholder="Descreva sua rotina..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="habit-category">
              <option value="health">ðŸƒ SaÃºde</option>
              <option value="productivity">ðŸ’¼ Produtividade</option>
              <option value="learning">ðŸ“š Aprendizado</option>
              <option value="mindfulness">ðŸ§˜ Mindfulness</option>
              <option value="social">ðŸ‘¥ Social</option>
              <option value="finance">ðŸ’° FinanÃ§as</option>
              <option value="other">ðŸ“Œ Outro</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">FrequÃªncia</label>
            <select class="form-select" id="habit-frequency">
              <option value="daily">DiÃ¡ria</option>
              <option value="weekly">Semanal</option>
              <option value="custom">Personalizada</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" class="form-checkbox" id="habit-reminder">
              <span style="margin-left: 8px;">Ativar lembrete</span>
            </label>
          </div>

          <div class="form-group">
            <label class="form-label">Horario</label>
            <input type="time" class="form-input" id="habit-time">
          </div>

          <div class="form-group">
            <label class="form-label">Janela do dia</label>
            <select class="form-select" id="habit-window">
              <option value="">Sem janela</option>
              <option value="morning">Manha</option>
              <option value="afternoon">Tarde</option>
              <option value="evening">Noite</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Repeticao</label>
            <select class="form-select" id="habit-repeat-type">
              <option value="DAILY">Diaria</option>
              <option value="WEEKLY">Semanal</option>
              <option value="MONTHLY">Mensal</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Intervalo (a cada)</label>
            <input type="number" class="form-input" id="habit-repeat-interval" value="1" min="1">
          </div>
        </form>
      `;

      modal.open('Nova Rotina', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Criar Rotina', onclick: 'habitHandlers.createHabit()', primary: true }
      ]);
    },

    createHabit: async function() {
      const name = document.getElementById('habit-name').value.trim();
      const description = document.getElementById('habit-description').value.trim();
      const category = document.getElementById('habit-category').value;
      const frequency = document.getElementById('habit-frequency').value;
      const reminder = document.getElementById('habit-reminder').checked;
      const scheduledTime = document.getElementById('habit-time').value;
      const timeWindow = document.getElementById('habit-window').value;
      const repeatType = document.getElementById('habit-repeat-type').value;
      const repeatInterval = parseInt(document.getElementById('habit-repeat-interval').value, 10) || 1;

      if (!name) {
        toast.error('Por favor, preencha o nome da rotina');
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);
      const primaryBtn = document.querySelector('.modal-footer .btn-primary');
      const primaryLabel = primaryBtn ? primaryBtn.textContent : '';
      if (primaryBtn) {
        primaryBtn.innerHTML = '<span class="material-icons rotating">sync</span> Criando...';
      }
      toast.info('Criando rotina...');

      const habitData = {
        name,
        description,
        category,
        frequency,
        reminderTime: reminder ? scheduledTime : '',
        scheduledTime,
        timeWindow,
        repeatEnabled: true,
        repeatType,
        repeatInterval,
        active: true
      };

      const result = await api.createHabit(habitData);

      modalActions.forEach(btn => btn.disabled = false);
      if (primaryBtn) {
        primaryBtn.textContent = primaryLabel;
      }

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Rotina criada com sucesso!');
      } else {
        toast.error('Erro ao criar rotina: ' + result.error);
      }
    },

    openEditModal: function(habitId) {
      const habit = appState.habits.find(h => h.id === habitId);
      if (!habit) {
        toast.error('Rotina nÃ£o encontrada');
        return;
      }

      const content = `
        <form id="edit-habit-form">
          <div class="form-group">
            <label class="form-label">Nome da Rotina *</label>
            <input type="text" class="form-input" id="edit-habit-name" value="${utils.sanitize(habit.name)}" required>
          </div>

          <div class="form-group">
            <label class="form-label">DescriÃ§Ã£o</label>
            <textarea class="form-textarea" id="edit-habit-description">${utils.sanitize(habit.description || '')}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="edit-habit-category">
              <option value="health" ${habit.category === 'health' ? 'selected' : ''}>ðŸƒ SaÃºde</option>
              <option value="productivity" ${habit.category === 'productivity' ? 'selected' : ''}>ðŸ’¼ Produtividade</option>
              <option value="learning" ${habit.category === 'learning' ? 'selected' : ''}>ðŸ“š Aprendizado</option>
              <option value="mindfulness" ${habit.category === 'mindfulness' ? 'selected' : ''}>ðŸ§˜ Mindfulness</option>
              <option value="social" ${habit.category === 'social' ? 'selected' : ''}>ðŸ‘¥ Social</option>
              <option value="finance" ${habit.category === 'finance' ? 'selected' : ''}>ðŸ’° FinanÃ§as</option>
              <option value="other" ${habit.category === 'other' ? 'selected' : ''}>ðŸ“Œ Outro</option>
            </select>
          </div>

                    <div class="form-group">
            <label class="form-label">Horario</label>
            <input type="time" class="form-input" id="edit-habit-time" value="${habit.scheduledTime || ''}">
          </div>

          <div class="form-group">
            <label class="form-label">Janela do dia</label>
            <select class="form-select" id="edit-habit-window">
              <option value="" ${!habit.timeWindow ? 'selected' : ''}>Sem janela</option>
              <option value="morning" ${habit.timeWindow === 'morning' ? 'selected' : ''}>Manha</option>
              <option value="afternoon" ${habit.timeWindow === 'afternoon' ? 'selected' : ''}>Tarde</option>
              <option value="evening" ${habit.timeWindow === 'evening' ? 'selected' : ''}>Noite</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Repeticao</label>
            <select class="form-select" id="edit-habit-repeat-type">
              <option value="DAILY" ${habit.repeatType === 'DAILY' ? 'selected' : ''}>Diaria</option>
              <option value="WEEKLY" ${habit.repeatType === 'WEEKLY' ? 'selected' : ''}>Semanal</option>
              <option value="MONTHLY" ${habit.repeatType === 'MONTHLY' ? 'selected' : ''}>Mensal</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Intervalo (a cada)</label>
            <input type="number" class="form-input" id="edit-habit-repeat-interval" value="${habit.repeatInterval || 1}" min="1">
          </div>
<div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-danger w-full" onclick="habitHandlers.deleteHabit('${habitId}')">
              <span class="material-icons">delete</span>
              Excluir Rotina
            </button>
          </div>
        </form>
      `;

      modal.open('Editar Rotina', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Salvar', onclick: 'habitHandlers.updateHabit("' + habitId + '")', primary: true }
      ]);
    },

    updateHabit: async function(habitId) {
      const name = document.getElementById('edit-habit-name').value.trim();
      const description = document.getElementById('edit-habit-description').value.trim();
      const category = document.getElementById('edit-habit-category').value;
      const scheduledTime = document.getElementById('edit-habit-time').value;
      const timeWindow = document.getElementById('edit-habit-window').value;
      const repeatType = document.getElementById('edit-habit-repeat-type').value;
      const repeatInterval = parseInt(document.getElementById('edit-habit-repeat-interval').value, 10) || 1;

      if (!name) {
        toast.error('Por favor, preencha o nome da rotina');
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);

      const updates = {
        name,
        description,
        category,
        scheduledTime,
        timeWindow,
        repeatEnabled: true,
        repeatType,
        repeatInterval
      };

      const result = await api.updateHabit(habitId, updates);

      modalActions.forEach(btn => btn.disabled = false);

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Rotina atualizada!');
      } else {
        toast.error('Erro ao atualizar rotina: ' + result.error);
      }
    },

    deleteHabit: async function(habitId) {
      if (!confirm('Tem certeza que deseja excluir esta rotina? Esta aï¿½ï¿½o nï¿½o pode ser desfeita.')) {
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);

      const result = await api.deleteHabit(habitId);

      modalActions.forEach(btn => btn.disabled = false);

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Rotina excluï¿½da!');
      } else {
        toast.error('Erro ao excluir rotina: ' + result.error);
      }
    }
  };

  const taskHandlers = {
    setStatus: async function(taskId, status) {
      const result = await api.setTaskStatus(taskId, status);

      if (result.ok) {
        applyFullState(result.data);
        refreshUI();
        toast.success('Tarefa atualizada!');
      } else {
        toast.error('Erro ao atualizar tarefa: ' + result.error);
      }
    },

    openCreateModal: function() {
      const content = `
        <form id="create-task-form">
          <div class="form-group">
            <label class="form-label">TÃ­tulo da Tarefa *</label>
            <input type="text" class="form-input" id="task-title" placeholder="Ex: Finalizar relatÃ³rio" required>
          </div>

          <div class="form-group">
            <label class="form-label">DescriÃ§Ã£o</label>
            <textarea class="form-textarea" id="task-description" placeholder="Descreva os detalhes da tarefa..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Prioridade</label>
            <select class="form-select" id="task-priority">
              <option value="low">ðŸŸ¢ Baixa</option>
              <option value="normal" selected>ðŸ”µ Normal</option>
              <option value="high">ðŸŸ¡ Alta</option>
              <option value="urgent">ðŸ”´ Urgente</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="task-status">
              <option value="todo" selected>ðŸ“‹ A Fazer</option>
              <option value="doing">âš¡ Em Andamento</option>
              <option value="done">âœ… ConcluÃ­do</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Data de Vencimento</label>
            <input type="date" class="form-input" id="task-due-date">
          </div>

          <div class="form-group">
            <label class="form-label">Hora</label>
            <input type="time" class="form-input" id="task-due-time">
          </div>

          <div class="form-group">
            <label class="form-label">Fuso horario</label>
            <select class="form-select" id="task-timezone">
              <option value="America/Sao_Paulo" selected>America/Sao_Paulo</option>
              <option value="UTC">UTC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Repeticao</label>
            <select class="form-select" id="task-repeat-type">
              <option value="">Sem repeticao</option>
              <option value="DAILY">Diaria</option>
              <option value="WEEKLY">Semanal</option>
              <option value="MONTHLY">Mensal</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Intervalo (a cada)</label>
            <input type="number" class="form-input" id="task-repeat-interval" value="1" min="1">
          </div>

          <div class="form-group">
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <input type="text" class="form-input" id="task-category" placeholder="Ex: Trabalho, Pessoal, Estudos">
          </div>
        </form>
      `;

      modal.open('Nova Tarefa', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Criar Tarefa', onclick: 'taskHandlers.createTask()', primary: true }
      ]);
    },

    createTask: async function() {
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-description').value.trim();
      const priority = document.getElementById('task-priority').value;
      const status = document.getElementById('task-status').value;
      const dueDate = document.getElementById('task-due-date').value;
      const dueTime = document.getElementById('task-due-time').value;
      const timezone = document.getElementById('task-timezone').value;
      const repeatType = document.getElementById('task-repeat-type').value;
      const repeatInterval = parseInt(document.getElementById('task-repeat-interval').value, 10) || 1;
      const category = document.getElementById('task-category').value.trim();

      // ValidaÃ§Ãµes robustas
      if (!utils.validateRequired(title, 'TÃ­tulo da tarefa')) return;
      if (dueDate && !utils.validateDate(dueDate, 'Data de vencimento', false)) return;
      if (dueTime && !utils.validateTime(dueTime, 'Hora de vencimento')) return;
      if (repeatType && !utils.validateNumber(repeatInterval, 'Intervalo de repetiÃ§Ã£o', 1, 365)) return;

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);
      const primaryBtn = document.querySelector('.modal-footer .btn-primary');
      const primaryLabel = primaryBtn ? primaryBtn.textContent : '';
      if (primaryBtn) {
        primaryBtn.textContent = 'Criando...';
        primaryBtn.classList.add('is-loading');
      }
      toast.info('Criando tarefa...');

      const taskData = {
        title,
        description,
        priority,
        status,
        dueDate: dueDate || null,
        dueTime: dueTime || null,
        timezone,
        repeatEnabled: repeatType !== '',
        repeatType,
        repeatInterval,
        category: category || null
      };

      const result = await api.createTask(taskData);

      modalActions.forEach(btn => btn.disabled = false);
      if (primaryBtn) {
        primaryBtn.textContent = primaryLabel;
        primaryBtn.classList.remove('is-loading');
      }

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Tarefa criada com sucesso!');
      } else {
        toast.error('Erro ao criar tarefa: ' + result.error);
      }
    },

    openEditModal: function(taskId) {
      const task = appState.tasks.find(t => t.id === taskId);
      if (!task) {
        toast.error('Tarefa nao encontrada');
        return;
      }

      const content = `
        <form id="edit-task-form">
          <div class="form-group">
            <label class="form-label">Titulo da Tarefa *</label>
            <input type="text" class="form-input" id="edit-task-title" value="${utils.sanitize(task.title)}" required>
          </div>

          <div class="form-group">
            <label class="form-label">Descricao</label>
            <textarea class="form-textarea" id="edit-task-description">${utils.sanitize(task.description || '')}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Prioridade</label>
            <select class="form-select" id="edit-task-priority">
              <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Baixa</option>
              <option value="normal" ${task.priority === 'normal' ? 'selected' : ''}>Normal</option>
              <option value="high" ${task.priority === 'high' ? 'selected' : ''}>Alta</option>
              <option value="urgent" ${task.priority === 'urgent' ? 'selected' : ''}>Urgente</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="edit-task-status">
              <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>A fazer</option>
              <option value="doing" ${task.status === 'doing' ? 'selected' : ''}>Em andamento</option>
              <option value="done" ${task.status === 'done' ? 'selected' : ''}>Concluido</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Data de Vencimento</label>
            <input type="date" class="form-input" id="edit-task-due-date" value="${task.dueDate || ''}">
          </div>

          <div class="form-group">
            <label class="form-label">Hora</label>
            <input type="time" class="form-input" id="edit-task-due-time" value="${task.dueTime || ''}">
          </div>

          <div class="form-group">
            <label class="form-label">Fuso horario</label>
            <select class="form-select" id="edit-task-timezone">
              <option value="America/Sao_Paulo" ${task.timezone === 'America/Sao_Paulo' ? 'selected' : ''}>America/Sao_Paulo</option>
              <option value="UTC" ${task.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Repeticao</label>
            <select class="form-select" id="edit-task-repeat-type">
              <option value="" ${!task.repeatType ? 'selected' : ''}>Sem repeticao</option>
              <option value="DAILY" ${task.repeatType === 'DAILY' ? 'selected' : ''}>Diaria</option>
              <option value="WEEKLY" ${task.repeatType === 'WEEKLY' ? 'selected' : ''}>Semanal</option>
              <option value="MONTHLY" ${task.repeatType === 'MONTHLY' ? 'selected' : ''}>Mensal</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Intervalo (a cada)</label>
            <input type="number" class="form-input" id="edit-task-repeat-interval" value="${task.repeatInterval || 1}" min="1">
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <input type="text" class="form-input" id="edit-task-category" value="${utils.sanitize(task.category || '')}">
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-danger w-full" onclick="taskHandlers.deleteTask('${taskId}')">
              <span class="material-icons">delete</span>
              Excluir Tarefa
            </button>
          </div>
        </form>
      `;

      modal.open('Editar Tarefa', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Salvar', onclick: 'taskHandlers.updateTask("' + taskId + '")', primary: true }
      ]);
    },

    updateTask: async function(taskId) {
      const title = document.getElementById('edit-task-title').value.trim();
      const description = document.getElementById('edit-task-description').value.trim();
      const priority = document.getElementById('edit-task-priority').value;
      const status = document.getElementById('edit-task-status').value;
      const dueDate = document.getElementById('edit-task-due-date').value;
      const dueTime = document.getElementById('edit-task-due-time').value;
      const timezone = document.getElementById('edit-task-timezone').value;
      const repeatType = document.getElementById('edit-task-repeat-type').value;
      const repeatInterval = parseInt(document.getElementById('edit-task-repeat-interval').value, 10) || 1;
      const category = document.getElementById('edit-task-category').value.trim();

      if (!title) {
        toast.error('Por favor, preencha o titulo da tarefa');
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);

      const updates = {
        title,
        description,
        priority,
        status,
        dueDate: dueDate || null,
        dueTime: dueTime || null,
        timezone,
        repeatEnabled: repeatType !== '',
        repeatType,
        repeatInterval,
        category: category || null
      };

      const result = await api.updateTask(taskId, updates);

      modalActions.forEach(btn => btn.disabled = false);

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Tarefa atualizada!');
      } else {
        toast.error('Erro ao atualizar tarefa: ' + result.error);
      }
    },

    deleteTask: async function(taskId) {
      if (!confirm('Tem certeza que deseja excluir esta tarefa? Esta aï¿½ï¿½o nï¿½o pode ser desfeita.')) {
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);

      const result = await api.deleteTask(taskId);

      modalActions.forEach(btn => btn.disabled = false);

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Tarefa excluï¿½da!');
      } else {
        toast.error('Erro ao excluir tarefa: ' + result.error);
      }
    }
  };

  const goalHandlers = {
    openCreateModal: function() {
      const content = `
        <form id="create-goal-form">
          <div class="form-group">
            <label class="form-label">Nome da Meta *</label>
            <input type="text" class="form-input" id="goal-name" placeholder="Ex: Ler 12 livros" required>
          </div>

          <div class="form-group">
            <label class="form-label">DescriÃ§Ã£o</label>
            <textarea class="form-textarea" id="goal-description" placeholder="Descreva sua meta..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Valor Atual</label>
            <input type="number" class="form-input" id="goal-current" value="0" min="0" step="1">
          </div>

          <div class="form-group">
            <label class="form-label">Valor Alvo *</label>
            <input type="number" class="form-input" id="goal-target" placeholder="Ex: 12" required min="1" step="1">
          </div>

          <div class="form-group">
            <label class="form-label">Unidade</label>
            <input type="text" class="form-input" id="goal-unit" placeholder="Ex: livros, km, horas">
          </div>

          <div class="form-group">
            <label class="form-label">Prazo</label>
            <input type="date" class="form-input" id="goal-deadline">
          </div>

          <div class="form-group">
            <label class="form-label">Hora</label>
            <input type="time" class="form-input" id="goal-deadline-time">
          </div>

          <div class="form-group">
            <label class="form-label">Fuso horario</label>
            <select class="form-select" id="goal-timezone">
              <option value="America/Sao_Paulo" selected>America/Sao_Paulo</option>
              <option value="UTC">UTC</option>
            </select>
          </div>

          <div class="form-group">
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="goal-category">
              <option value="health">ðŸƒ SaÃºde</option>
              <option value="career">ðŸ’¼ Carreira</option>
              <option value="learning">ðŸ“š Aprendizado</option>
              <option value="finance">ðŸ’° FinanÃ§as</option>
              <option value="personal">ðŸŽ¯ Pessoal</option>
              <option value="other">ðŸ“Œ Outro</option>
            </select>
          </div>
        </form>
      `;

      modal.open('Nova Meta', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Criar Meta', onclick: 'goalHandlers.createGoal()', primary: true }
      ]);
    },

    createGoal: async function() {
      const title = document.getElementById('goal-name').value.trim();
      const metric = document.getElementById('goal-description').value.trim();
      const currentValue = parseInt(document.getElementById('goal-current').value) || 0;
      const targetValue = parseInt(document.getElementById('goal-target').value);
      const unit = document.getElementById('goal-unit').value.trim();
      const deadline = document.getElementById('goal-deadline').value;
      const deadlineTime = document.getElementById('goal-deadline-time').value;
      const timezone = document.getElementById('goal-timezone').value;
      const category = document.getElementById('goal-category').value;

      // ValidaÃ§Ãµes robustas
      if (!utils.validateRequired(title, 'Nome da meta')) return;
      if (!utils.validateNumber(targetValue, 'Valor alvo', 1, 1000000000)) return;
      if (!utils.validateNumber(currentValue, 'Valor atual', 0, 1000000000)) return;
      if (deadline && !utils.validateDate(deadline, 'Data limite', false)) return;
      if (deadlineTime && !utils.validateTime(deadlineTime, 'Hora limite')) return;

      if (currentValue > targetValue) {
        toast.error('O valor atual nÃ£o pode ser maior que o valor alvo');
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);
      const primaryBtn = document.querySelector('.modal-footer .btn-primary');
      const primaryLabel = primaryBtn ? primaryBtn.textContent : '';
      if (primaryBtn) {
        primaryBtn.innerHTML = '<span class="material-icons rotating">sync</span> Criando...';
      }
      toast.info('Criando meta...');

      const goalData = {
        title,
        metric,
        currentValue,
        targetValue,
        unit: unit || null,
        dueDate: deadline || null,
        dueTime: deadlineTime || null,
        timezone,
        category,
        status: 'active'
      };

      const result = await api.createGoal(goalData);

      modalActions.forEach(btn => btn.disabled = false);
      if (primaryBtn) {
        primaryBtn.textContent = primaryLabel;
      }

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Meta criada com sucesso!');
      } else {
        toast.error('Erro ao criar meta: ' + result.error);
      }
    },

    openEditModal: function(goalId) {
      const goal = appState.goals.find(g => g.id === goalId);
      if (!goal) {
        toast.error('Meta nao encontrada');
        return;
      }

      const content = `
        <form id="edit-goal-form">
          <div class="form-group">
            <label class="form-label">Nome da Meta *</label>
            <input type="text" class="form-input" id="edit-goal-name" value="${utils.sanitize(goal.title || goal.name || '')}" required>
          </div>

          <div class="form-group">
            <label class="form-label">Descricao</label>
            <textarea class="form-textarea" id="edit-goal-description">${utils.sanitize(goal.metric || goal.description || '')}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Valor Atual</label>
            <input type="number" class="form-input" id="edit-goal-current" value="${goal.currentValue || 0}" min="0" step="1">
          </div>

          <div class="form-group">
            <label class="form-label">Valor Alvo *</label>
            <input type="number" class="form-input" id="edit-goal-target" value="${goal.targetValue || 0}" required min="1" step="1">
          </div>

          <div class="form-group">
            <label class="form-label">Unidade</label>
            <input type="text" class="form-input" id="edit-goal-unit" value="${utils.sanitize(goal.unit || '')}">
          </div>

          <div class="form-group">
            <label class="form-label">Prazo</label>
            <input type="date" class="form-input" id="edit-goal-deadline" value="${goal.dueDate || goal.deadline || ''}">
          </div>

          <div class="form-group">
            <label class="form-label">Hora</label>
            <input type="time" class="form-input" id="edit-goal-deadline-time" value="${goal.dueTime || ''}">
          </div>

          <div class="form-group">
            <label class="form-label">Fuso horario</label>
            <select class="form-select" id="edit-goal-timezone">
              <option value="America/Sao_Paulo" ${goal.timezone === 'America/Sao_Paulo' ? 'selected' : ''}>America/Sao_Paulo</option>
              <option value="UTC" ${goal.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="edit-goal-category">
              <option value="health">Saude</option>
              <option value="career">Carreira</option>
              <option value="learning">Aprendizado</option>
              <option value="finance">Financas</option>
              <option value="personal">Pessoal</option>
              <option value="other">Outro</option>
            </select>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-danger w-full" onclick="goalHandlers.deleteGoal('${goalId}')">
              <span class="material-icons">delete</span>
              Excluir Meta
            </button>
          </div>
        </form>
      `;

      modal.open('Editar Meta', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Salvar', onclick: 'goalHandlers.updateGoal("' + goalId + '")', primary: true }
      ]);
    },

    updateGoal: async function(goalId) {
      const title = document.getElementById('edit-goal-name').value.trim();
      const metric = document.getElementById('edit-goal-description').value.trim();
      const currentValue = parseInt(document.getElementById('edit-goal-current').value) || 0;
      const targetValue = parseInt(document.getElementById('edit-goal-target').value);
      const unit = document.getElementById('edit-goal-unit').value.trim();
      const deadline = document.getElementById('edit-goal-deadline').value;
      const deadlineTime = document.getElementById('edit-goal-deadline-time').value;
      const timezone = document.getElementById('edit-goal-timezone').value;
      const category = document.getElementById('edit-goal-category').value;

      if (!title) {
        toast.error('Por favor, preencha o nome da meta');
        return;
      }

      if (!targetValue || targetValue <= 0) {
        toast.error('Por favor, defina um valor alvo valido');
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);

      const updates = {
        title,
        metric,
        currentValue,
        targetValue,
        unit: unit || null,
        dueDate: deadline || null,
        dueTime: deadlineTime || null,
        timezone,
        category
      };

      const result = await api.updateGoal(goalId, updates);

      modalActions.forEach(btn => btn.disabled = false);

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Meta atualizada!');
      } else {
        toast.error('Erro ao atualizar meta: ' + result.error);
      }
    },

    addProgress: async function(goalId) {
      const deltaInput = document.getElementById('goal-progress-delta');
      const delta = parseInt(deltaInput.value);

      if (!delta || delta === 0) {
        toast.error('Por favor, insira um valor vÃ¡lido');
        return;
      }

      const result = await api.addGoalProgress(goalId, delta, '', utils.getTodayISO());

      if (result.ok) {
        applyFullState(result.data);
        refreshUI();
        toast.success('Progresso adicionado!');
        deltaInput.value = '';

        // Atualizar o valor atual no modal
        const goal = appState.goals.find(g => g.id === goalId);
        if (goal) {
          document.getElementById('edit-goal-current').value = goal.currentValue || 0;
        }
      } else {
        toast.error('Erro ao adicionar progresso: ' + result.error);
      }
    },

    deleteGoal: async function(goalId) {
      if (!confirm('Tem certeza que deseja excluir esta meta? Esta aï¿½ï¿½o nï¿½o pode ser desfeita.')) {
        return;
      }

      const modalActions = document.querySelectorAll('.modal-footer button');
      modalActions.forEach(btn => btn.disabled = true);

      const result = await api.deleteGoal(goalId);

      modalActions.forEach(btn => btn.disabled = false);

      if (result.ok) {
        applyFullState(result.data);
        modal.close();
        refreshUI();
        toast.success('Meta excluï¿½da!');
      } else {
        toast.error('Erro ao excluir meta: ' + result.error);
      }
    }
  };

  const settingsHandlers = {
    exportData: async function() {
      toast.info('Exportando dados...');
      const result = await api.exportUserData('json');

      if (result.ok) {
        toast.success('Dados exportados com sucesso!');
      } else {
        toast.error('Erro ao exportar dados: ' + result.error);
      }
    }
  };

  const agendaHandlers = {
    state: {
      date: utils.getTodayISO()
    },

    today: function() {
      this.state.date = utils.getTodayISO();
      refreshUI();
    },

    nextDay: function() {
      const date = new Date(this.state.date);
      date.setDate(date.getDate() + 1);
      this.state.date = date.toISOString().split('T')[0];
      refreshUI();
    },

    previousDay: function() {
      const date = new Date(this.state.date);
      date.setDate(date.getDate() - 1);
      this.state.date = date.toISOString().split('T')[0];
      refreshUI();
    }
  };

  const calendarHandlers = {
    openDay: function(dateStr) {
      const date = new Date(dateStr);
      const dayTasks = appState.tasks.filter(t => t.dueDate === dateStr);
      const dayHabits = appState.habits.filter(h => {
        if (h.active === false) return false;
        if (h.nextOccurrence) return h.nextOccurrence === dateStr;
        return true;
      });

      const content = `
        <div style="max-height: 60vh; overflow-y: auto;">
          <div style="margin-bottom: 24px;">
            <h3 style="color: var(--text-primary); margin-bottom: 8px;">${utils.formatRelativeDate(dateStr)}</h3>
            <p style="color: var(--text-secondary); font-size: 14px;">${date.toLocaleDateString('pt-BR', { weekday: 'long' })}</p>
          </div>

          ${dayHabits.length > 0 ? `
            <div style="margin-bottom: 24px;">
              <h4 style="color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 20px;">check_circle</span>
                Rotinas (${dayHabits.length})
              </h4>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${dayHabits.map(habit => {
                  const log = appState.habitLogs.find(l => l.habitId === habit.id && l.date === dateStr);
                  const completed = log?.completed || false;
                  return `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: 500; color: var(--text-primary);">${utils.sanitize(habit.name)}</div>
                        ${habit.scheduledTime ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${utils.formatTime(habit.scheduledTime)}</div>` : ''}
                      </div>
                      <span class="material-icons" style="color: ${completed ? 'var(--accent-green)' : 'var(--text-tertiary)'};">
                        ${completed ? 'check_circle' : 'radio_button_unchecked'}
                      </span>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : ''}

          ${dayTasks.length > 0 ? `
            <div>
              <h4 style="color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 20px;">task_alt</span>
                Tarefas (${dayTasks.length})
              </h4>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${dayTasks.map(task => {
                  const priorityColors = { high: 'var(--accent-red)', medium: 'var(--accent-orange)', low: 'var(--accent-blue)' };
                  const statusLabels = { todo: 'A fazer', doing: 'Em andamento', done: 'ConcluÃ­do' };
                  return `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="font-weight: 500; color: var(--text-primary);">${utils.sanitize(task.title)}</div>
                        <span class="badge" style="background: ${priorityColors[task.priority] || 'var(--accent-blue)'}20; color: ${priorityColors[task.priority] || 'var(--accent-blue)'}; font-size: 11px; padding: 2px 8px;">
                          ${task.priority || 'medium'}
                        </span>
                      </div>
                      <div style="font-size: 12px; color: var(--text-secondary);">
                        ${statusLabels[task.status] || task.status}
                        ${task.dueTime ? ` â€¢ ${utils.formatTime(task.dueTime)}` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : ''}

          ${dayHabits.length === 0 && dayTasks.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
              <span class="material-icons" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;">event_available</span>
              <p>Nenhuma atividade planejada para este dia</p>
            </div>
          ` : ''}
        </div>
      `;

      modal.open(`Detalhes do Dia`, content, [
        { label: 'Fechar', onclick: 'modal.close()', primary: false }
      ]);
    }
  };

  const focusHandlers = {
    timerId: null,
    sessionStart: null,

    pickTask: function() {
      const options = appState.tasks.map(task => `
        <option value="${utils.sanitize(task.id)}">${utils.sanitize(task.title)}</option>
      `).join('');
      const content = `
        <div class="form-group">
          <label class="form-label">Selecione uma tarefa</label>
          <select class="form-select" id="focus-task-select">${options}</select>
        </div>
      `;
      modal.open('Selecionar tarefa', content, [
        { label: 'Cancelar', onclick: 'modal.close()', primary: false },
        { label: 'Confirmar', onclick: 'focusHandlers.applyTask()', primary: true }
      ]);
    },

    applyTask: function() {
      const select = document.getElementById('focus-task-select');
      if (!select) return;
      appState.focus.taskId = select.value;
      modal.close();
      refreshUI();
    },

    toggle: function() {
      if (appState.focus.isRunning) {
        appState.focus.isRunning = false;
        clearInterval(this.timerId);
        refreshUI();
        return;
      }

      appState.focus.isRunning = true;
      this.sessionStart = this.sessionStart || new Date().toISOString();
      this.timerId = setInterval(() => {
        if (!appState.focus.isRunning) return;
        appState.focus.remainingSeconds -= 1;
        if (appState.focus.remainingSeconds <= 0) {
          this.completeSession();
        }
        refreshUI();
      }, 1000);
      refreshUI();
    },

    reset: function() {
      appState.focus.remainingSeconds = 1500;
      appState.focus.isRunning = false;
      this.sessionStart = null;
      clearInterval(this.timerId);
      refreshUI();
    },

    completeSession: async function() {
      const endedAt = new Date().toISOString();
      const durationMinutes = 25;
      appState.focus.isRunning = false;
      appState.focus.remainingSeconds = 1500;
      clearInterval(this.timerId);
      refreshUI();

      if (appState.focus.taskId) {
        await api.call('logFocusSession', appState.userKey, appState.focus.taskId, this.sessionStart, endedAt, durationMinutes);
      }

      toast.success('Sessao de foco concluida!');
      this.sessionStart = null;
    }
  };

  const clickupHandlers = {
    syncNow: async function() {
      const btn = document.getElementById('clickup-sync-btn');
      const statusDiv = document.getElementById('clickup-status');

      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Sincronizando...';
      }

      toast.info('Iniciando sincronizaÃ§Ã£o com ClickUp...');

      try {
        const result = await api.call('syncClickUpNow');

        if (result.ok) {
          const sheet = result.sheet || {};
          const routine = result.routine || {};

          const summary = `
            ƒo. SincronizaÇõÇœo concluÇðda!<br>
            ÐY"¾ ${sheet.fetched || 0} tarefas obtidas do ClickUp<br>
            ÐY'ó ${sheet.upserted || 0} salvas no banco (${sheet.inserted || 0} novas, ${sheet.updated || 0} atualizadas)<br>
            ÐY"- ${routine.synced || 0} sincronizadas | ${routine.skipped || 0} fora da view | ${routine.errors || 0} erro(s)<br>
            ƒ?ñ‹÷? Tempo: ${Math.round((result.totalDurationMs || 0) / 1000)}s
          `;

          if (statusDiv) {
            statusDiv.innerHTML = `
              <div style="padding: 12px; background: rgba(52, 168, 83, 0.1); border-left: 3px solid #34a853; border-radius: 4px;">
                <div style="font-size: 13px; line-height: 1.6;">${summary}</div>
                <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                  Ãšltima sincronizaÃ§Ã£o: ${new Date().toLocaleString('pt-BR')}
                </small>
              </div>
            `;
          }

          toast.success('SincronizaÃ§Ã£o concluÃ­da!');
        } else {
          toast.error('Erro na sincronizaÃ§Ã£o: ' + (result.error || 'Erro desconhecido'));

          if (statusDiv) {
            statusDiv.innerHTML = `
              <div style="padding: 12px; background: rgba(234, 67, 53, 0.1); border-left: 3px solid #ea4335; border-radius: 4px;">
                <div style="font-size: 13px; color: var(--error-color);">
                  âŒ Erro: ${utils.sanitize(result.error || 'Erro desconhecido')}
                </div>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Erro ao sincronizar ClickUp:', error);
        toast.error('Erro ao sincronizar: ' + error.toString());
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<span class="material-icons">sync</span> Sincronizar Agora';
        }
      }
    },

    checkStatus: async function() {
      const statusDiv = document.getElementById('clickup-status');
      if (!statusDiv) return;

      try {
        const result = await api.call('getLastSyncStatus');

        if (result.ok && result.lastSync) {
          const sync = result.lastSync;
          const timestamp = new Date(sync.timestamp).toLocaleString('pt-BR');

          if (sync.success) {
            const summary = sync.summary || {};
            statusDiv.innerHTML = `
              <div style="padding: 12px; background: rgba(52, 168, 83, 0.1); border-left: 3px solid #34a853; border-radius: 4px;">
                <div style="font-size: 13px;">
                  âœ… Ãšltima sincronizaÃ§Ã£o bem-sucedida<br>
                  ðŸ“Š ${summary.fetched || 0} tarefas | ${summary.synced || 0} sincronizadas | ${summary.skipped || 0} fora da view | ${summary.errors || 0} erro(s) | ${Math.round((summary.duration || 0) / 1000)}s<br>Salvas: ${summary.upserted || 0} (${summary.inserted || 0} novas, ${summary.updated || 0} atualizadas) | Fora da view: ${summary.outOfView || 0}
                </div>
                <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                  ${timestamp}
                </small>
              </div>
            `;
          } else {
            statusDiv.innerHTML = `
              <div style="padding: 12px; background: rgba(234, 67, 53, 0.1); border-left: 3px solid #ea4335; border-radius: 4px;">
                <div style="font-size: 13px; color: var(--error-color);">
                  âŒ Ãšltima sincronizaÃ§Ã£o falhou<br>
                  ${sync.stage ? `Etapa: ${utils.sanitize(sync.stage)}` : ''}<br>
                  ${utils.sanitize(sync.error || 'Erro desconhecido')}
                </div>
                <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                  ${timestamp}
                </small>
              </div>
            `;
          }
        } else {
          statusDiv.innerHTML = `
            <div style="padding: 12px; background: rgba(251, 188, 5, 0.1); border-left: 3px solid #fbbc05; border-radius: 4px;">
              <div style="font-size: 13px;">
                â„¹ï¸ Nenhuma sincronizaÃ§Ã£o realizada ainda
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao verificar status:', error);
      }
    }
  };

  const clickupPageHandlers = {
    state: {
      query: '',
      status: 'all',
      priority: 'all',
      assignee: '',
      dueStart: '',
      dueEnd: '',
      updatedStart: '',
      updatedEnd: '',
      onlyMine: true,
      onlyUnassigned: false,
      sortBy: 'updated',
      sortDir: 'desc',
      includeForaDaView: false,
      page: 1,
      pageSize: 25,
      total: 0,
      items: [],
      isLoading: false
    },

    init: function() {
      this.bindEvents();
      this.updateFilterButtons();
      this.loadStatus();
      this.resetAndLoad();
    },

    bindEvents: function() {
      const searchInput = document.getElementById('clickup-search');
      if (searchInput) {
        searchInput.addEventListener('input', utils.debounce(() => {
          this.state.query = searchInput.value.trim();
          this.resetAndLoad();
        }, 400));
      }

      const assigneeInput = document.getElementById('clickup-filter-assignee');
      if (assigneeInput) {
        assigneeInput.addEventListener('input', utils.debounce(() => {
          this.state.assignee = assigneeInput.value.trim();
          this.resetAndLoad();
        }, 400));
      }

      const prioritySelect = document.getElementById('clickup-filter-priority');
      if (prioritySelect) {
        prioritySelect.addEventListener('change', () => {
          this.state.priority = prioritySelect.value;
          this.resetAndLoad();
        });
      }

      const sortSelect = document.getElementById('clickup-sort');
      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          const value = sortSelect.value || 'updated:desc';
          const parts = value.split(':');
          this.state.sortBy = parts[0] || 'updated';
          this.state.sortDir = parts[1] || 'desc';
          this.resetAndLoad();
        });
      }

      const dueStartInput = document.getElementById('clickup-filter-due-start');
      if (dueStartInput) {
        dueStartInput.addEventListener('change', () => {
          this.state.dueStart = dueStartInput.value;
          this.resetAndLoad();
        });
      }

      const dueEndInput = document.getElementById('clickup-filter-due-end');
      if (dueEndInput) {
        dueEndInput.addEventListener('change', () => {
          this.state.dueEnd = dueEndInput.value;
          this.resetAndLoad();
        });
      }

      const updatedStartInput = document.getElementById('clickup-filter-updated-start');
      if (updatedStartInput) {
        updatedStartInput.addEventListener('change', () => {
          this.state.updatedStart = updatedStartInput.value;
          this.resetAndLoad();
        });
      }

      const updatedEndInput = document.getElementById('clickup-filter-updated-end');
      if (updatedEndInput) {
        updatedEndInput.addEventListener('change', () => {
          this.state.updatedEnd = updatedEndInput.value;
          this.resetAndLoad();
        });
      }

      document.querySelectorAll('.clickup-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          this.state.status = btn.getAttribute('data-status') || 'all';
          this.updateFilterButtons();
          this.resetAndLoad();
        });
      });

      const onlyMineBtn = document.getElementById('clickup-toggle-only-mine');
      if (onlyMineBtn) {
        onlyMineBtn.addEventListener('click', () => {
          this.state.onlyMine = !this.state.onlyMine;
          if (this.state.onlyMine) {
            this.state.onlyUnassigned = false;
          }
          this.updateFilterButtons();
          this.resetAndLoad();
        });
      }

      const unassignedBtn = document.getElementById('clickup-toggle-unassigned');
      if (unassignedBtn) {
        unassignedBtn.addEventListener('click', () => {
          this.state.onlyUnassigned = !this.state.onlyUnassigned;
          if (this.state.onlyUnassigned) {
            this.state.onlyMine = false;
          }
          this.updateFilterButtons();
          this.resetAndLoad();
        });
      }

      const toggleBtn = document.getElementById('clickup-toggle-out-of-view');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          this.state.includeForaDaView = !this.state.includeForaDaView;
          this.updateFilterButtons();
          this.resetAndLoad();
        });
      }

      const clearBtn = document.getElementById('clickup-clear-filters');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          this.state.query = '';
          this.state.status = 'all';
          this.state.priority = 'all';
          this.state.assignee = '';
          this.state.dueStart = '';
          this.state.dueEnd = '';
          this.state.updatedStart = '';
          this.state.updatedEnd = '';
          this.state.onlyMine = true;
          this.state.onlyUnassigned = false;
          this.state.includeForaDaView = false;
          this.state.sortBy = 'updated';
          this.state.sortDir = 'desc';

          const searchInput = document.getElementById('clickup-search');
          if (searchInput) searchInput.value = '';
          const assigneeInput = document.getElementById('clickup-filter-assignee');
          if (assigneeInput) assigneeInput.value = '';
          const prioritySelect = document.getElementById('clickup-filter-priority');
          if (prioritySelect) prioritySelect.value = 'all';
          const sortSelect = document.getElementById('clickup-sort');
          if (sortSelect) sortSelect.value = 'updated:desc';
          const dueStartInput = document.getElementById('clickup-filter-due-start');
          if (dueStartInput) dueStartInput.value = '';
          const dueEndInput = document.getElementById('clickup-filter-due-end');
          if (dueEndInput) dueEndInput.value = '';
          const updatedStartInput = document.getElementById('clickup-filter-updated-start');
          if (updatedStartInput) updatedStartInput.value = '';
          const updatedEndInput = document.getElementById('clickup-filter-updated-end');
          if (updatedEndInput) updatedEndInput.value = '';

          this.updateFilterButtons();
          this.resetAndLoad();
        });
      }
    },

    updateFilterButtons: function() {
      document.querySelectorAll('.clickup-filter').forEach(btn => {
        const status = btn.getAttribute('data-status');
        const isActive = status === this.state.status;
        btn.classList.toggle('btn-primary', isActive);
        btn.classList.toggle('btn-secondary', !isActive);
      });

      const toggleBtn = document.getElementById('clickup-toggle-out-of-view');
      if (toggleBtn) {
        toggleBtn.setAttribute('data-active', this.state.includeForaDaView ? 'true' : 'false');
        toggleBtn.classList.toggle('btn-primary', this.state.includeForaDaView);
        toggleBtn.classList.toggle('btn-secondary', !this.state.includeForaDaView);
      }

      const onlyMineBtn = document.getElementById('clickup-toggle-only-mine');
      if (onlyMineBtn) {
        onlyMineBtn.setAttribute('data-active', this.state.onlyMine ? 'true' : 'false');
        onlyMineBtn.classList.toggle('btn-primary', this.state.onlyMine);
        onlyMineBtn.classList.toggle('btn-secondary', !this.state.onlyMine);
      }

      const unassignedBtn = document.getElementById('clickup-toggle-unassigned');
      if (unassignedBtn) {
        unassignedBtn.setAttribute('data-active', this.state.onlyUnassigned ? 'true' : 'false');
        unassignedBtn.classList.toggle('btn-primary', this.state.onlyUnassigned);
        unassignedBtn.classList.toggle('btn-secondary', !this.state.onlyUnassigned);
      }
    },

    resetAndLoad: function() {
      this.state.page = 1;
      this.state.items = [];
      this.renderList({ loading: true });
      this.loadPage(true);
    },

    loadMore: function() {
      if (this.state.isLoading) return;
      if (this.state.items.length >= this.state.total) return;
      this.state.page += 1;
      this.loadPage(false);
    },

    loadPage: async function(isReset) {
      if (this.state.isLoading) return;
      this.state.isLoading = true;
      this.setLoadingIndicator('Carregando tarefas...');

      const result = await api.listClickUpTasks({
        userKey: appState.userKey,
        query: this.state.query,
        status: this.state.status,
        priority: this.state.priority,
        assignee: this.state.assignee,
        dueStart: this.state.dueStart,
        dueEnd: this.state.dueEnd,
        updatedStart: this.state.updatedStart,
        updatedEnd: this.state.updatedEnd,
        onlyMine: this.state.onlyMine,
        onlyUnassigned: this.state.onlyUnassigned,
        sortBy: this.state.sortBy,
        sortDir: this.state.sortDir,
        page: this.state.page,
        pageSize: this.state.pageSize,
        includeForaDaView: this.state.includeForaDaView
      });

      if (result.ok) {
        const payload = result.data || {};
        const items = payload.items || [];
        this.state.total = payload.total || 0;
        if (isReset) {
          this.state.items = items;
        } else {
          this.state.items = this.state.items.concat(items);
        }
        this.renderList();
      } else {
        this.setLoadingIndicator('');
        this.renderList();
        toast.error('Erro ao carregar tarefas: ' + result.error);
      }

      this.state.isLoading = false;
      this.setLoadingIndicator('');
    },

    setLoadingIndicator: function(message) {
      const el = document.getElementById('clickup-loading-indicator');
      if (el) el.textContent = message || '';
    },

    formatDate: function(value, withTime) {
      if (!value) return '';
      let date = null;
      if (typeof value === 'number' || /^\d+$/.test(String(value))) {
        date = new Date(parseInt(value, 10));
      } else {
        date = new Date(value);
      }
      if (isNaN(date)) return String(value);
      return withTime ? date.toLocaleString('pt-BR') : date.toLocaleDateString('pt-BR');
    },

    renderPriorityBadge: function(priority) {
      if (!priority) return '<span style="color: var(--text-tertiary);">-</span>';
      const value = String(priority).toLowerCase();
      let badgeClass = 'badge-normal';
      if (value.includes('urgent')) badgeClass = 'badge-urgent';
      else if (value.includes('high')) badgeClass = 'badge-high';
      else if (value.includes('low')) badgeClass = 'badge-low';
      return `<span class="badge ${badgeClass}">${utils.sanitize(priority)}</span>`;
    },

    renderStatusPill: function(status) {
      if (!status) return '<span style="color: var(--text-tertiary);">-</span>';
      return `
        <span style="
          display: inline-flex;
          align-items: center;
          padding: 4px 10px;
          border-radius: 999px;
          font-size: 12px;
          font-weight: 600;
          background: rgba(59, 130, 246, 0.12);
          color: var(--accent-blue);
          border: 1px solid rgba(59, 130, 246, 0.3);
        ">
          ${utils.sanitize(status)}
        </span>
      `;
    },

    renderList: function(options) {
      const container = document.getElementById('clickup-tasks-list');
      const summary = document.getElementById('clickup-results-summary');
      const loadMoreWrap = document.getElementById('clickup-load-more-wrap');

      if (!container) return;

      if (options && options.loading) {
        container.innerHTML = `
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        `;
        if (summary) summary.textContent = 'Carregando...';
        if (loadMoreWrap) loadMoreWrap.style.display = 'none';
        return;
      }

      const items = this.state.items || [];
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">fact_check</span>
            <h3 class="empty-state-title">Nenhuma tarefa encontrada</h3>
            <p class="empty-state-description">Ajuste os filtros ou sincronize novamente.</p>
          </div>
        `;
        if (summary) summary.textContent = '0 tarefas';
        if (loadMoreWrap) loadMoreWrap.style.display = 'none';
        return;
      }

      const headerRow = `
        <div style="display: grid; grid-template-columns: 2.2fr 1fr 1fr 1.2fr 1fr 1.2fr 120px; gap: 12px; align-items: center; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); font-weight: 700;">
          <div>Titulo</div>
          <div>Status</div>
          <div>Prioridade</div>
          <div>Responsavel</div>
          <div>Due date</div>
          <div>Atualizado em</div>
          <div>Acoes</div>
        </div>
      `;

      const rows = items.map(task => `
        <div style="display: grid; grid-template-columns: 2.2fr 1fr 1fr 1.2fr 1fr 1.2fr 120px; gap: 12px; align-items: center; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md);">
          <div>
            <div style="font-weight: 600;">
              ${utils.sanitize(task.name || '')}
              ${task.fora_da_view ? '<span class="chip chip-warning" style="margin-left: 8px;">Fora da view</span>' : ''}
            </div>
            <div style="font-size: 12px; color: var(--text-tertiary);">#${utils.sanitize(task.task_id || '')}</div>
          </div>
          <div>${this.renderStatusPill(task.status)}</div>
          <div>${this.renderPriorityBadge(task.priority)}</div>
          <div style="color: var(--text-secondary); font-size: 14px;">${utils.sanitize(task.responsavel_principal || task.assignees || task.responsavel_email || '-')}</div>
          <div style="font-size: 14px;">${this.formatDate(task.due_date, false) || '-'}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${this.formatDate(task.date_updated, true) || '-'}</div>
          <div>
            ${task.task_url ? `
              <a class="btn btn-sm btn-secondary" href="${utils.sanitize(task.task_url)}" target="_blank" rel="noopener">
                Abrir
              </a>
            ` : '-'}
          </div>
        </div>
      `).join('');

      container.innerHTML = `<div style="display: grid; gap: 10px;">${headerRow}${rows}</div>`;

      if (summary) {
        summary.textContent = `Mostrando ${items.length} de ${this.state.total} tarefas`;
      }

      if (loadMoreWrap) {
        loadMoreWrap.style.display = items.length < this.state.total ? 'flex' : 'none';
      }
    },

    loadStatus: async function() {
      const statusDiv = document.getElementById('clickup-page-status');
      if (!statusDiv) return;

      try {
        const result = await api.call('getLastSyncStatus');

        if (result.ok && result.lastSync) {
          const sync = result.lastSync;
          const timestamp = new Date(sync.timestamp).toLocaleString('pt-BR');

          if (sync.success) {
            const summary = sync.summary || {};
            statusDiv.innerHTML = `
              <div style="padding: 12px; background: rgba(52, 168, 83, 0.1); border-left: 3px solid #34a853; border-radius: 4px;">
                <div style="font-size: 13px;">
                  Sincronizacao concluida<br>
                  ${summary.fetched || 0} tarefas | ${summary.synced || 0} sincronizadas | ${summary.skipped || 0} fora da view | ${summary.errors || 0} erro(s) | ${Math.round((summary.duration || 0) / 1000)}s<br>Salvas: ${summary.upserted || 0} (${summary.inserted || 0} novas, ${summary.updated || 0} atualizadas) | Fora da view: ${summary.outOfView || 0}
                </div>
                <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                  ${timestamp}
                </small>
              </div>
            `;
          } else {
            statusDiv.innerHTML = `
              <div style="padding: 12px; background: rgba(234, 67, 53, 0.1); border-left: 3px solid #ea4335; border-radius: 4px;">
                <div style="font-size: 13px; color: var(--error-color);">
                  Ultima sincronizacao falhou<br>
                  ${sync.stage ? `Etapa: ${utils.sanitize(sync.stage)}` : ''}<br>
                  ${utils.sanitize(sync.error || 'Erro desconhecido')}
                </div>
                <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                  ${timestamp}
                </small>
              </div>
            `;
          }
        } else {
          statusDiv.innerHTML = `
            <div style="padding: 12px; background: rgba(251, 188, 5, 0.1); border-left: 3px solid #fbbc05; border-radius: 4px;">
              <div style="font-size: 13px;">
                Nenhuma sincronizacao realizada ainda
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao verificar status:', error);
      }
    },

    syncNow: async function() {
      const btn = document.getElementById('clickup-page-sync-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Sincronizando...';
      }

      toast.info('Iniciando sincronizacao com ClickUp...');

      try {
        const result = await api.call('syncClickUpNow');

        if (result.ok) {
          toast.success('Sincronizacao concluida!');
          this.loadStatus();
          this.resetAndLoad();
        } else {
          toast.error('Erro na sincronizacao: ' + (result.error || 'Erro desconhecido'));
        }
      } catch (error) {
        console.error('Erro ao sincronizar ClickUp:', error);
        toast.error('Erro ao sincronizar: ' + error.toString());
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<span class="material-icons">sync</span> Sincronizar agora';
        }
      }
    }
  };

  const notificationHandlers = {
    state: {
      items: [],
      isLoading: false
    },

    load: async function() {
      this.state.isLoading = true;
      const items = notifications.buildItems();

      try {
        const result = await api.call('getLastSyncStatus');
        if (result.ok && result.lastSync && result.lastSync.success === false) {
          const sync = result.lastSync;
          items.unshift({
            id: `clickup-sync-${sync.timestamp || 'unknown'}`,
            type: 'clickup',
            title: 'Sincronizacao ClickUp falhou',
            message: sync.error || 'Erro desconhecido',
            timestamp: sync.timestamp || utils.getTodayISO(),
            action: { label: 'Ir para ClickUp', view: 'clickup' }
          });
        }
      } catch (error) {
        console.warn('Erro ao carregar status do ClickUp para notificacoes', error);
      }

      this.state.items = items;
      this.state.isLoading = false;
      this.render();
    },

    render: function() {
      const container = document.getElementById('notifications-list');
      const summary = document.getElementById('notifications-summary');
      if (!container) return;

      if (this.state.isLoading) {
        container.innerHTML = `
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        `;
        if (summary) summary.textContent = 'Carregando...';
        return;
      }

      const items = this.state.items || [];
      const unreadCount = items.filter(item => !notifications.isRead(item.id)).length;
      if (summary) {
        summary.textContent = `${unreadCount} nao lidas de ${items.length} notificacoes`;
      }

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons empty-state-icon">notifications</span>
            <h3 class="empty-state-title">Nenhuma notificacao</h3>
            <p class="empty-state-description">Tudo em dia por aqui.</p>
          </div>
        `;
        notifications.refreshBadge(items);
        return;
      }

      const iconMap = {
        task: 'task_alt',
        habit: 'check_circle',
        goal: 'flag',
        clickup: 'fact_check'
      };

      container.innerHTML = items.map(item => {
        const isRead = notifications.isRead(item.id);
        const icon = iconMap[item.type] || 'info';
        const timeLabel = item.timestamp ? new Date(item.timestamp).toLocaleString('pt-BR') : '';
        return `
          <div class="notification-item ${isRead ? '' : 'unread'}">
            <div class="notification-icon"><span class="material-icons">${icon}</span></div>
            <div class="notification-body">
              <div class="notification-title">${utils.sanitize(item.title || '')}</div>
              <div class="notification-message">${utils.sanitize(item.message || '')}</div>
              <div class="notification-meta">${utils.sanitize(timeLabel)}</div>
            </div>
            <div class="notification-actions">
              ${item.action ? `<button class="btn btn-sm btn-secondary" onclick="notificationHandlers.openAction('${item.action.view}')">${utils.sanitize(item.action.label)}</button>` : ''}
              ${isRead ? '' : `<button class="btn btn-sm btn-primary" onclick="notificationHandlers.markRead('${item.id}')">Marcar como lida</button>`}
            </div>
          </div>
        `;
      }).join('');

      notifications.refreshBadge(items);
    },

    markRead: function(id) {
      notifications.markRead(id);
      this.render();
    },

    markAllRead: function() {
      notifications.markAllRead(this.state.items);
      this.render();
    },

    openAction: function(view) {
      if (view) {
        router.navigate(view);
      }
    }
  };
  const authHandlers = {
    logout: function() {
      if (confirm('Tem certeza que deseja sair?')) {
        storage.remove('appCache');
        storage.remove('theme');
        storage.remove('preferences');
        window.location.reload();
      }
    }
  };

  window.habitHandlers = habitHandlers;
  window.taskHandlers = taskHandlers;
  window.goalHandlers = goalHandlers;
  window.settingsHandlers = settingsHandlers;
  window.agendaHandlers = agendaHandlers;
  window.focusHandlers = focusHandlers;
  window.clickupHandlers = clickupHandlers;
  window.clickupPageHandlers = clickupPageHandlers;
  window.notificationHandlers = notificationHandlers;
  window.authHandlers = authHandlers;
  window.router = router;
  window.utils = utils;
  window.toast = toast;
  window.api = api;

  // ============================================
  // INITIALIZATION
  // ============================================
  // VerificaÃ§Ã£o defensiva de autenticaÃ§Ã£o
  async function checkAuth() {
    try {
      const sessionInfo = await api.call('getSessionInfo');

      if (!sessionInfo.ok || !sessionInfo.loggedIn) {
        console.warn('UsuÃ¡rio nÃ£o autenticado, redirecionando para login do Google...');

        // Evitar loop se jÃ¡ estivermos no bootstrap
        if (window.location.pathname && window.location.pathname.includes('bootstrap')) {
          console.log('JÃ¡ estamos no bootstrap, nÃ£o redirecionar novamente');
          return false;
        }

        // Redirecionar para forÃ§ar login padrÃ£o do Google
        // O backend vai detectar que nÃ£o estÃ¡ logado e retornar bootstrap.html
        console.log('Recarregando para mostrar bootstrap e forÃ§ar login Google');
        window.location.reload();

        return false;
      }

      console.log('âœ… AutenticaÃ§Ã£o verificada:', sessionInfo.email);
      return true;

    } catch (error) {
      console.error('âŒ Erro ao verificar autenticaÃ§Ã£o:', error);

      // Em caso de erro, mostrar mensagem ao invÃ©s de tela branca
      const appContainer = document.getElementById('app');
      const loadingScreen = document.getElementById('loading-screen');

      if (loadingScreen) loadingScreen.style.display = 'none';
      if (appContainer) {
        appContainer.style.display = 'flex';
        appContainer.innerHTML = `
          <div style="padding: 40px; text-align: center; margin: auto;">
            <span class="material-icons" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;">error_outline</span>
            <h2 style="color: var(--text-primary); margin-bottom: 12px;">Erro ao carregar aplicativo</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              NÃ£o foi possÃ­vel verificar sua autenticaÃ§Ã£o. Tente recarregar a pÃ¡gina.
            </p>
            <button class="btn btn-primary" onclick="location.reload()">
              <span class="material-icons">refresh</span>
              Recarregar
            </button>
          </div>
        `;
      }

      return false;
    }
  }

  async function initializeApp() {
    const loadingScreen = document.getElementById('loading-screen');
    const appContainer = document.getElementById('app');

    // Atualizar mensagem de loading
    const updateLoadingMessage = (msg) => {
      const loadingText = loadingScreen?.querySelector('p');
      if (loadingText) loadingText.textContent = msg;
    };

    const maxRetries = 2;
    let attempt = 0;

    while (attempt < maxRetries) {
      try {
        attempt++;
        if (attempt > 1) {
          updateLoadingMessage(`Tentativa ${attempt}/${maxRetries}...`);
          console.log(`Tentativa ${attempt}/${maxRetries} de inicializar o app...`);
        } else {
          updateLoadingMessage('Conectando ao servidor...');
        }

        const result = await api.initApp();

        if (result.ok) {
          updateLoadingMessage('Carregando dados...');
          applyFullState(result.data);
          notifications.refreshBadge();
          storage.save('appCache', appState);

          updateLoadingMessage('Preparando interface...');

          // Atualizar email do usuÃ¡rio na sidebar
          const userEmailElement = document.getElementById('user-email');
          if (userEmailElement) {
            userEmailElement.textContent = result.data.userKey || 'UsuÃ¡rio';
          }

          // Usar requestAnimationFrame para suavizar a transiÃ§Ã£o
          requestAnimationFrame(() => {
            if (appContainer) {
              appContainer.style.display = '';
            }
            if (loadingScreen) {
              loadingScreen.style.opacity = '0';
              loadingScreen.style.transition = 'opacity 0.3s ease';
              setTimeout(() => {
                loadingScreen.style.display = 'none';
              }, 300);
            }

            router.init();
            toast.success('Bem-vindo ao THX Ops!');
          });

          return; // Sucesso, sair da funÃ§Ã£o
        } else {
          // Se houver erro e ainda hÃ¡ tentativas, esperar e tentar novamente
          if (attempt < maxRetries) {
            updateLoadingMessage(`Reconectando em 1 segundo...`);
            console.warn(`Falha na tentativa ${attempt}, tentando novamente em 1 segundo...`);
            await new Promise(resolve => setTimeout(resolve, 1000));
            continue;
          }
          // Ãšltima tentativa falhou, mostrar tela de erro
          showErrorScreen(result.error || 'Erro desconhecido ao carregar aplicaÃ§Ã£o');
        }
      } catch (error) {
        console.error(`Erro na tentativa ${attempt}:`, error);
        if (attempt < maxRetries) {
          updateLoadingMessage(`Reconectando em 1 segundo...`);
          await new Promise(resolve => setTimeout(resolve, 1000));
          continue;
        }
        showErrorScreen('Erro ao inicializar aplicaÃ§Ã£o. Por favor, recarregue a pÃ¡gina.');
      }
    }
  }

  function showErrorScreen(message) {
    const loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
      loadingScreen.innerHTML = `
        <div style="text-align: center; max-width: 400px;">
          <span class="material-icons" style="font-size: 72px; color: var(--accent-red); margin-bottom: 24px;">error</span>
          <h2 style="margin-bottom: 16px; color: var(--text-primary);">Erro ao carregar</h2>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">${utils.sanitize(message)}</p>
          <button class="btn btn-primary" onclick="window.location.reload()">
            <span class="material-icons">refresh</span>
            Tentar novamente
          </button>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', async function() {
    theme.init();

    // VerificaÃ§Ã£o defensiva de autenticaÃ§Ã£o antes de tudo
    const isAuthenticated = await checkAuth();
    if (!isAuthenticated) {
      console.log('AutenticaÃ§Ã£o falhou, nÃ£o inicializando app');
      return;
    }

    // Verificar se hÃ¡ dados em cache para carregar rapidamente
    const cachedData = storage.load('appCache');
    if (cachedData && cachedData.userKey) {
      console.log('Dados em cache encontrados, carregando...');
      applyFullState(cachedData);
      notifications.refreshBadge();
    }

    // Inicializar app
    initializeApp();
  });

})();
</script>





















































